<!-- Se elimin칩 el selector de idioma con bot칩n, ahora se maneja desde los formularios principales -->

<!-- Estilos m칤nimos necesarios -->
<style>
  .alert-warning {
    background-color: #fff3cd;
    color: #664d03;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #ffecb5;
    margin: 10px 0;
  }

  .alert-danger {
    background-color: #f8d7da;
    color: #842029;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #f5c2c7;
    margin: 10px 0;
  }

  .card {
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 15px;
  }

  .card-body {
    padding: 8px;
  }

  .img-fluid {
    max-width: 100%;
    height: auto;
  }
</style>

<!-- PRIMERO: Mostrar la imagen o el mensaje de error -->
{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% elif imagen %}
<div class="card">
  <div class="card-body">
    <img
      src="{{ imagen }}"
      alt="Etiqueta generada"
      style="background-color: white; max-width: 100%"
    />
  </div>
</div>
{% else %}
<div class="alert alert-warning">
  No se pudo generar la vista previa. Verifica el c칩digo ZPL y los par치metros.
</div>
{% endif %}

<!-- SEGUNDO: Mostrar el mensaje de advertencia si hay variables con fallback -->
{% if variables_con_fallback_es != "[]" %}
<div
  class="alert alert-warning"
  style="margin-top: 15px; border-left: 5px solid #ffc107; padding: 15px"
>
  <strong style="font-size: 16px">丘멆잺 Advertencia:</strong>
  <p>
    Las siguientes variables no tienen traducci칩n en el idioma
    <strong>{{ idioma_actual }}</strong> y se est치n mostrando en espa침ol:
  </p>

  <!-- Variables listadas directamente sin JavaScript -->
  <div
    style="
      margin-top: 10px;
      background-color: #fff8e1;
      padding: 10px;
      border-radius: 4px;
      border: 1px dashed #ffb300;
    "
  >
    <!-- Mostrar directamente el texto con las variables -->
    {% if variables_fallback_texto %}
    <div
      style="font-weight: bold; color: #dd6b20; font-size: 15px"
      id="direct-variables"
    >
      {{ variables_fallback_texto }}
    </div>
    {% else %}
    <!-- Fallback en caso de que el texto directo no est칠 disponible -->
    <div
      style="font-weight: bold; color: #dd6b20; font-size: 15px"
      id="direct-variables"
    >
      {{ variables_con_fallback_es }}
    </div>
    {% endif %}

    <!-- Respaldo con JavaScript para mejor formato -->
    <div
      style="font-weight: bold; color: #dd6b20; font-size: 15px; display: none"
      id="variables-fallback-list"
    ></div>
  </div>
</div>

<script>
  // Procesamos inmediatamente para mostrar las variables
  try {
    // Guardamos el valor raw para depuraci칩n
    const variablesRaw = "{{ variables_con_fallback_es|escapejs }}";
    console.log("Variables Raw:", variablesRaw);

    // Intentamos parsear como JSON
    const variables = JSON.parse(variablesRaw);
    console.log("Variables parseadas:", variables);

    if (variables && variables.length > 0) {
      // Reemplazar el contenido del elemento directo con un formato mejor
      document.getElementById("variables-fallback-list").innerHTML = variables
        .map(
          (v) =>
            `<span style="background-color: #fff3cd; padding: 3px 6px; margin: 2px; border-radius: 3px; border: 1px solid #ffeeba; display: inline-block;">${v}</span>`
        )
        .join(" ");
      document.getElementById("variables-fallback-list").style.display =
        "block";
      document.getElementById("direct-variables").style.display = "none";

      // Tambi칠n mostramos una alerta para asegurar que el usuario vea el mensaje
      setTimeout(function () {
        alert(
          "ADVERTENCIA: Las siguientes variables no tienen traducci칩n en el idioma '" +
            "{{ idioma_actual }}" +
            "' y se est치n mostrando en espa침ol: " +
            variables.join(", ")
        );
      }, 800);
    } else {
      console.log("Array de variables vac칤o o nulo");
    }
  } catch (e) {
    console.error("Error al procesar variables:", e);
  }
</script>
{% endif %}

<!-- TERCERO: Mostrar mensaje de error si hay variables que faltan en la base de datos -->
{% if variables_faltantes != "[]" %}
<div
  class="alert alert-danger"
  style="margin-top: 15px; border-left: 5px solid #dc3545; padding: 15px"
>
  <strong style="font-size: 16px">游뛂 Error:</strong>
  <p>Las siguientes variables no existen en la base de datos:</p>

  <!-- Variables faltantes listadas directamente sin JavaScript -->
  <div
    style="
      margin-top: 10px;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      border: 1px dashed #dc3545;
    "
  >
    <!-- Mostrar directamente el texto con las variables -->
    {% if variables_faltantes_texto %}
    <div
      style="font-weight: bold; color: #dc3545; font-size: 15px"
      id="direct-missing-variables"
    >
      {{ variables_faltantes_texto }}
    </div>
    {% else %}
    <!-- Fallback en caso de que el texto directo no est칠 disponible -->
    <div
      style="font-weight: bold; color: #dc3545; font-size: 15px"
      id="direct-missing-variables"
    >
      {{ variables_faltantes }}
    </div>
    {% endif %}

    <!-- Respaldo con JavaScript para mejor formato -->
    <div
      style="font-weight: bold; color: #dc3545; font-size: 15px; display: none"
      id="variables-missing-list"
    ></div>
  </div>

  <script>
    // Procesamos inmediatamente para mostrar las variables faltantes
    try {
      // Guardamos el valor raw para depuraci칩n
      const missingVarsRaw = "{{ variables_faltantes|escapejs }}";
      console.log("Variables Faltantes Raw:", missingVarsRaw);

      // Intentamos parsear como JSON
      const missingVars = JSON.parse(missingVarsRaw);
      console.log("Variables Faltantes parseadas:", missingVars);

      if (missingVars && missingVars.length > 0) {
        // Reemplazar el contenido del elemento directo con un formato mejor
        document.getElementById("variables-missing-list").innerHTML =
          missingVars
            .map(
              (v) =>
                `<span style="background-color: #f8d7da; padding: 3px 6px; margin: 2px; border-radius: 3px; border: 1px solid #f5c2c7; display: inline-block;">${v}</span>`
            )
            .join(" ");
        document.getElementById("variables-missing-list").style.display =
          "block";
        document.getElementById("direct-missing-variables").style.display =
          "none";
      } else {
        console.log("Array de variables faltantes vac칤o o nulo");
      }
    } catch (e) {
      console.error("Error al procesar variables faltantes:", e);
    }
  </script>
</div>
{% endif %}

<!-- Esta implementaci칩n simplificada utiliza alertas est치ndar para mostrar las advertencias sobre variables sin traducci칩n -->
