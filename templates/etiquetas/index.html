<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <title>Generador de Etiquetas</title>
    <style>
      /* Estilos responsivos para im√°genes */
      #target_etiqueta img,
      #target_etiqueta_existente img {
        max-width: 100%;
        height: auto;
        max-height: 550px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }

      /* Mejoras responsivas */
      .form-control,
      .form-select {
        margin-bottom: 0.5rem;
      }

      /* Ajustes para dispositivos m√≥viles */
      @media (max-width: 768px) {
        .container {
          padding-left: 1rem;
          padding-right: 1rem;
        }

        h1 {
          font-size: 1.75rem;
          margin: 1rem 0;
        }

        .btn {
          width: 100%;
          margin-bottom: 0.5rem;
        }

        .d-flex.gap-2 {
          flex-direction: column;
        }
      }

      /* Estilos para el switch del modo oscuro */
      .theme-switch {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 1030;
      }

      /* Estilos para los temas */
      [data-bs-theme="dark"] {
        --bs-body-bg: #212529;
        --bs-body-color: #e9ecef;
      }

      [data-bs-theme="dark"] .card {
        --bs-card-bg: #343a40;
      }

      [data-bs-theme="dark"] .form-control {
        background-color: #2b3035;
        color: #e9ecef;
        border-color: #495057;
      }

      [data-bs-theme="dark"] .form-select {
        background-color: #2b3035;
        color: #e9ecef;
        border-color: #495057;
      }
    </style>
  </head>
  <body>
    <!-- Bot√≥n de cambio de tema -->
    <div class="theme-switch">
      <button class="btn btn-outline-secondary" id="theme-toggle">
        <i class="bi bi-sun-fill" id="theme-icon"></i>
      </button>
    </div>
    <div class="container px-4">
      <h1 class="my-4 text-center text-lg-start">
        Sistema de Generaci√≥n de Etiquetas
      </h1>

      <ul
        class="nav nav-tabs mb-4 flex-column flex-sm-row"
        id="myTab"
        role="tablist"
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active w-100 text-center"
            id="manual-tab"
            data-bs-toggle="tab"
            data-bs-target="#manual"
            type="button"
            role="tab"
            aria-controls="manual"
            aria-selected="true"
          >
            <i class="bi bi-pencil-square"></i> Edici√≥n Manual
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link w-100 text-center"
            id="etiquetas-tab"
            data-bs-toggle="tab"
            data-bs-target="#etiquetas"
            type="button"
            role="tab"
            aria-controls="etiquetas"
            aria-selected="false"
          >
            <i class="bi bi-card-list"></i> Etiquetas Existentes
          </button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <!-- Tab de edici√≥n manual -->
        <div
          class="tab-pane fade show active"
          id="manual"
          role="tabpanel"
          aria-labelledby="manual-tab"
        >
          <div class="row">
            <div class="col-12 col-lg-6">
              <form
                hx-post="{% url 'etiqueta_png' %}"
                hx-target="#target_etiqueta"
                hx-swap="innerHTML"
              >
                {% csrf_token %}
                <div class="mb-3">
                  <label for="etiqueta" class="form-label">C√≥digo ZPL:</label>
                  {% if descripcion_zpl %}
                  <textarea
                    class="form-control"
                    name="etiqueta"
                    id="etiqueta"
                    rows="12"
                  >
{{ descripcion_zpl }}</textarea
                  >
                  {% else %}
                  <textarea
                    class="form-control"
                    name="etiqueta"
                    id="etiqueta"
                    rows="12"
                  >
                    ^XA
                    ^FO50,50^ADN,36,20^FDHola Mundo^FS
                    ^XZ
</textarea
                  >
                  {% endif %}
                </div>
                <div class="row">
                  <div class="col-12 col-sm-6">
                    <div class="mb-3">
                      <label for="variable" class="form-label"
                        >Variables Disponibles:</label
                      >
                      <select class="form-select" name="variable" id="variable">
                        {% for variable in variables %}
                        <option value="{{ variable }}">{{ variable }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <!-- Nueva secci√≥n para la creaci√≥n de etiquetas -->
                  <div class="col-12 col-sm-6">
                    <div class="mb-3">
                      <label for="nombre_etiqueta" class="form-label"
                        >Nombre de etiqueta:</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="nombre_etiqueta"
                        id="nombre_etiqueta"
                        placeholder="Nombre para la etiqueta"
                      />
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="tipo_etiqueta_manual" class="form-label"
                        >Tipo:</label
                      >
                      <select
                        class="form-select"
                        name="tipo_etiqueta_manual"
                        id="tipo_etiqueta_manual"
                      >
                        {% for tipo in tipos_etiquetas %}
                        <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="impresora_id" class="form-label"
                        >Impresora:</label
                      >
                      <select
                        class="form-select"
                        name="impresora_id"
                        id="impresora_id"
                      >
                        {% for impresora in impresoras %}
                        <option value="{{ impresora.id }}">
                          {{ impresora.dpi }} DPI
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="insumo_id" class="form-label">Tama√±o:</label>
                      <select
                        class="form-select"
                        name="insumo_id"
                        id="insumo_id"
                      >
                        {% for insumo in insumos %}
                        <option value="{{ insumo.id }}">
                          {{ insumo.tamanio }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="rotacion_id" class="form-label"
                        >Rotaci√≥n:</label
                      >
                      <select
                        class="form-select"
                        name="rotacion_id"
                        id="rotacion_id"
                      >
                        {% for rotacion in rotaciones %}
                        <option value="{{ rotacion.id }}">
                          {{ rotacion.angulo }}¬∞
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                  <button
                    class="btn btn-success"
                    type="button"
                    onclick="guardarNuevaEtiqueta()"
                  >
                    <i class="bi bi-save"></i> Crear etiqueta
                  </button>
                </div>
              </form>
            </div>
            <div class="col-12 col-lg-6 mt-4 mt-lg-0">
              <div id="target_etiqueta" class="text-center">
                <div class="alert alert-info mb-3" id="config_info_manual">
                  Seleccione impresora, tama√±o y rotaci√≥n para previsualizar
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab de etiquetas existentes -->
        <div
          class="tab-pane fade"
          id="etiquetas"
          role="tabpanel"
          aria-labelledby="etiquetas-tab"
        >
          <div class="row">
            <div class="col-12 col-lg-6">
              <form id="etiquetasForm">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="tipo_etiqueta" class="form-label"
                    >Seleccione el tipo:</label
                  >
                  <select
                    class="form-select"
                    name="tipo_etiqueta"
                    id="tipo_etiqueta"
                    onchange="filtrarEtiquetas()"
                  >
                    <option value="">Todos los tipos</option>
                    {% for tipo in tipos_etiquetas %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="etiqueta_id" class="form-label"
                    >Seleccione una etiqueta:</label
                  >
                  <select
                    class="form-select"
                    name="etiqueta_id"
                    id="etiqueta_id"
                  >
                    <option value="">-- Seleccione una etiqueta --</option>
                    {% if etiquetas %} {% for etiqueta in etiquetas %}
                    <option
                      value="{{ etiqueta.id }}"
                      data-tipo="{{ etiqueta.tipo_etiqueta }}"
                    >
                      {{ etiqueta.nombre }} ({{ etiqueta.tipo_etiqueta }})
                    </option>
                    {% endfor %} {% else %}
                    <option value="">No hay etiquetas disponibles</option>
                    {% endif %}
                  </select>
                </div>

                <div class="mb-3" id="zplEditorContainer" style="display: none">
                  <label for="zpl_editor" class="form-label">C√≥digo ZPL:</label>
                  <textarea
                    class="form-control"
                    name="zpl_editor"
                    id="zpl_editor"
                    rows="12"
                  ></textarea>
                </div>

                <div
                  class="row"
                  id="configExistenteContainer"
                  style="display: none"
                >
                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="impresora_id_existente" class="form-label"
                        >Impresora:</label
                      >
                      <select
                        class="form-select"
                        name="impresora_id_existente"
                        id="impresora_id_existente"
                      >
                        {% for impresora in impresoras %}
                        <option value="{{ impresora.id }}">
                          {{ impresora.dpi }} DPI
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="insumo_id_existente" class="form-label"
                        >Tama√±o:</label
                      >
                      <select
                        class="form-select"
                        name="insumo_id_existente"
                        id="insumo_id_existente"
                      >
                        {% for insumo in insumos %}
                        <option value="{{ insumo.id }}">
                          {{ insumo.tamanio }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="rotacion_id_existente" class="form-label"
                        >Rotaci√≥n:</label
                      >
                      <select
                        class="form-select"
                        name="rotacion_id_existente"
                        id="rotacion_id_existente"
                      >
                        {% for rotacion in rotaciones %}
                        <option value="{{ rotacion.id }}">
                          {{ rotacion.angulo }}¬∞
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <div
                  class="mb-3"
                  id="nombreActualContainer"
                  style="display: none"
                >
                  <label for="nombre_etiqueta_actual" class="form-label"
                    >Nombre de la etiqueta:</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    name="nombre_etiqueta_actual"
                    id="nombre_etiqueta_actual"
                    placeholder="Nombre de la etiqueta actual"
                  />
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                  <button
                    class="btn btn-success"
                    type="button"
                    id="btnGuardarZPL"
                    onclick="guardarZPL()"
                    style="display: none"
                  >
                    <i class="bi bi-save"></i> Guardar cambios
                  </button>
                </div>
              </form>
            </div>
            <div class="col-12 col-lg-6 mt-4 mt-lg-0">
              <div id="target_etiqueta_existente" class="text-center">
                <div class="alert alert-info mb-3" id="config_info_existente">
                  Seleccione una etiqueta para previsualizar
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      // Variables globales para la gesti√≥n de etiquetas
      let etiquetaActualId = null;
      let timeoutManual = null; // Variable para controlar el debounce en edici√≥n manual
      let timeoutExistente = null; // Variable para controlar el debounce en etiquetas existentes

      // Funci√≥n para actualizar la UI cuando se carga una etiqueta
      function actualizarUIEtiquetaCargada(mostrar) {
        try {
          // Elementos que deben mostrarse/ocultarse cuando se carga una etiqueta
          const elementosUI = [
            "zplEditorContainer",
            "btnGuardarZPL",
            "configExistenteContainer",
            "nombreActualContainer", // Incluir el contenedor del nombre
          ];

          // Mostrar u ocultar elementos seg√∫n el par√°metro
          elementosUI.forEach((id) => {
            const elemento = document.getElementById(id);
            if (elemento) {
              elemento.style.display = mostrar
                ? id === "configExistenteContainer"
                  ? "flex"
                  : "block"
                : "none";
              console.log(
                `${mostrar ? "Mostrando" : "Ocultando"} elemento: ${id}`
              );
            } else {
              console.warn(`Elemento no encontrado: ${id}`);
            }
          });

          // Si no se muestra, limpiar valores
          if (!mostrar) {
            const zplEditor = document.getElementById("zpl_editor");
            const nombreEtiquetaInput = document.getElementById(
              "nombre_etiqueta_actual"
            );

            if (zplEditor) zplEditor.value = "";
            if (nombreEtiquetaInput) nombreEtiquetaInput.value = "";

            etiquetaActualId = null;
          }
        } catch (err) {
          console.error("Error en actualizarUIEtiquetaCargada:", err);
        }
      }

      let configActualManual = {
        impresora: null,
        insumo: null,
        rotacion: null,
      };
      let configActualExistente = {
        impresora: null,
        insumo: null,
        rotacion: null,
      };

      // Funci√≥n para filtrar las etiquetas seg√∫n el tipo seleccionado
      function filtrarEtiquetas() {
        try {
          const tipoSeleccionado =
            document.getElementById("tipo_etiqueta").value;
          const selectEtiquetas = document.getElementById("etiqueta_id");
          const opciones = selectEtiquetas.options;

          // Reiniciar el select de etiquetas
          selectEtiquetas.selectedIndex = 0;
          document.getElementById("zplEditorContainer").style.display = "none";
          document.getElementById("btnGuardarZPL").style.display = "none";
          document.getElementById("configExistenteContainer").style.display =
            "none";

          // Ocultar tambi√©n el contenedor del nombre de la etiqueta
          const nombreActualContainer = document.getElementById(
            "nombreActualContainer"
          );
          if (nombreActualContainer) {
            nombreActualContainer.style.display = "none";
            console.log(
              "Ocultando contenedor de nombre al cambiar tipo de etiqueta"
            );
          }

          document.getElementById("zpl_editor").value = "";
          etiquetaActualId = null;

          // Restablecer el div de informaci√≥n
          document.getElementById("config_info_existente").innerHTML =
            "Seleccione una etiqueta para previsualizar";

          document.getElementById("target_etiqueta_existente").innerHTML =
            '<div class="alert alert-info mb-3" id="config_info_existente">Seleccione una etiqueta para previsualizar</div>';

          // Mostrar/ocultar opciones seg√∫n el tipo seleccionado
          let opcionesVisibles = 0;
          for (let i = 1; i < opciones.length; i++) {
            const opcion = opciones[i];
            const tipoEtiqueta = opcion.getAttribute("data-tipo");

            if (!tipoSeleccionado || tipoEtiqueta === tipoSeleccionado) {
              opcion.style.display = "";
              opcionesVisibles++;
            } else {
              opcion.style.display = "none";
            }
          }

          // Verificar si hay etiquetas disponibles para el tipo seleccionado
          if (opcionesVisibles === 0 && tipoSeleccionado) {
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-warning">No hay etiquetas disponibles para el tipo: ${tipoSeleccionado}</div>`;
          }
        } catch (err) {
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error al filtrar etiquetas: ${err.message}</div>`;
        }
      }

      // Funci√≥n para cargar el ZPL de una etiqueta seleccionada
      function cargarZPL(etiquetaId) {
        try {
          if (!etiquetaId) {
            // Ocultar todos los elementos UI
            actualizarUIEtiquetaCargada(false);

            // Limpiar campos
            document.getElementById("zpl_editor").value = "";
            document.getElementById("nombre_etiqueta_actual").value = "";
            // Ya no necesitamos esto porque eliminamos el contenedor
            // document.getElementById("nombre_nueva_etiqueta").value = "";
            etiquetaActualId = null;

            // Resetear mensajes
            document.getElementById("config_info_existente").innerHTML =
              "Seleccione una etiqueta para previsualizar";
            document.getElementById("target_etiqueta_existente").innerHTML =
              '<div class="alert alert-info mb-3" id="config_info_existente">Seleccione una etiqueta para previsualizar</div>';
            return;
          }

          // Guardar el ID de la etiqueta seleccionada
          etiquetaActualId = etiquetaId;

          // Obtener el nombre actual de la etiqueta seleccionada
          const etiquetaOption = document.querySelector(
            `#etiqueta_id option[value="${etiquetaId}"]`
          );
          const nombreEtiqueta = etiquetaOption ? etiquetaOption.text : "";

          // Mostrar todos los elementos UI para edici√≥n
          actualizarUIEtiquetaCargada(true);

          // Establecer el nombre actual de la etiqueta
          document.getElementById("nombre_etiqueta_actual").value =
            nombreEtiqueta;

          // Mostrar mensaje de carga
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-info">
              <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              Cargando etiqueta...
            </div>`;

          // Construir la URL con URL reversa para asegurar que la ruta es correcta
          const baseUrl = "{% url 'get_zpl' 0 %}";
          // Verificar que la URL base se construye correctamente
          if (!baseUrl || baseUrl === "{% url 'get_zpl' 0 %}") {
            throw new Error(
              "Error al construir la URL. No se pudo utilizar la etiqueta de plantilla."
            );
          }

          const url = baseUrl.replace("/0/", `/${etiquetaId}/`);
          console.log("URL construida:", url);

          // Configuraci√≥n de la solicitud
          const requestOptions = {
            method: "GET",
            headers: {
              Accept: "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            cache: "no-store", // Evitar cach√©
          };

          // Solicitar el contenido ZPL de la etiqueta seleccionada y sus datos de configuraci√≥n
          fetch(url, requestOptions)
            .then((response) => {
              console.log(
                "Respuesta recibida:",
                response.status,
                response.statusText
              );
              if (!response.ok) {
                throw new Error(
                  `Error HTTP: ${response.status} - ${response.statusText}`
                );
              }
              return response.json().catch((err) => {
                console.error("Error al parsear JSON:", err);
                throw new Error("El servidor no devolvi√≥ un JSON v√°lido");
              });
            })
            .then((data) => {
              console.log("ZPL cargado correctamente:", data);

              if (!data || (typeof data.zpl === "undefined" && !data.error)) {
                throw new Error(
                  "La respuesta no contiene datos ZPL ni un mensaje de error"
                );
              }

              if (data.error) {
                throw new Error(`Error del servidor: ${data.error}`);
              }

              // Mostrar el editor ZPL y el bot√≥n de guardar
              document.getElementById("zplEditorContainer").style.display =
                "block";
              document.getElementById("btnGuardarZPL").style.display =
                "inline-block";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "flex";

              // Cargar el ZPL en el editor
              const zplEditor = document.getElementById("zpl_editor");
              if (!zplEditor) {
                throw new Error("No se encontr√≥ el elemento zpl_editor");
              }
              zplEditor.value = data.zpl || "";

              if (!data.zpl || data.zpl.trim() === "") {
                console.warn("El ZPL recibido est√° vac√≠o");
                document.getElementById(
                  "config_info_existente"
                ).innerHTML = `<div class="alert alert-warning">La etiqueta no contiene c√≥digo ZPL</div>`;
                return;
              }

              // Actualizar la informaci√≥n de configuraci√≥n
              if (data.config) {
                console.log("Config recibida:", data.config);

                // Verificar que todos los selectores existen
                const impresoraEl = document.getElementById(
                  "impresora_id_existente"
                );
                const insumoEl = document.getElementById("insumo_id_existente");
                const rotacionEl = document.getElementById(
                  "rotacion_id_existente"
                );

                if (!impresoraEl || !insumoEl || !rotacionEl) {
                  console.error(
                    "No se encontraron todos los selectores de configuraci√≥n"
                  );
                  throw new Error(
                    "No se encontraron los selectores de configuraci√≥n necesarios"
                  );
                }

                // Establecer los valores de los selectores
                impresoraEl.value = data.config.impresora_id;
                insumoEl.value = data.config.insumo_id;
                rotacionEl.value = data.config.rotacion_id;

                actualizarInfoConfigExistente(data.config);
                configActualExistente = {
                  impresora: data.config.impresora_id,
                  insumo: data.config.insumo_id,
                  rotacion: data.config.rotacion_id,
                };

                // Generar previsualizaci√≥n inmediatamente
                generarPreviewInmediato(data.zpl, data.config);
              } else {
                console.warn(
                  "No se recibieron datos de configuraci√≥n completos"
                );
                document.getElementById(
                  "config_info_existente"
                ).innerHTML += `<div class="alert alert-warning">No se recibi√≥ la configuraci√≥n completa de la etiqueta</div>`;
              }
            })
            .catch((error) => {
              console.error("Error al cargar ZPL:", error);
              document.getElementById("zplEditorContainer").style.display =
                "none";
              document.getElementById("btnGuardarZPL").style.display = "none";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "none";
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al cargar el ZPL: ${error.message}</div>`;
            });
        } catch (err) {
          console.error("Error en cargarZPL:", err);
          // Ocultar todos los elementos UI
          actualizarUIEtiquetaCargada(false);
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error general: ${err.message}</div>`;
        }
      }

      // Funci√≥n para generar la etiqueta with el ZPL actual
      function generarEtiqueta(isPreview = false) {
        try {
          if (!etiquetaActualId) {
            if (!isPreview) {
              alert("Por favor, seleccione una etiqueta");
            }
            console.warn("No hay etiqueta seleccionada");
            return;
          }

          // Obtener y validar el ZPL
          const zplEditor = document.getElementById("zpl_editor");
          if (!zplEditor) {
            console.error("Elemento zpl_editor no encontrado");
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-danger">Error: Editor ZPL no encontrado</div>`;
            return;
          }

          const zpl = zplEditor.value;
          if (!zpl || zpl.trim() === "") {
            console.warn("ZPL vac√≠o en generarEtiqueta");
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-warning">El c√≥digo ZPL no puede estar vac√≠o</div>`;
            return;
          }

          // Obtener el token CSRF
          const csrfTokenElement = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          );
          if (!csrfTokenElement) {
            console.error("Token CSRF no encontrado");
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-danger">Error: Token CSRF no encontrado</div>`;
            return;
          }
          const csrfToken = csrfTokenElement.value;

          // Obtener configuraci√≥n seleccionada
          const impresoraEl = document.getElementById("impresora_id_existente");
          const insumoEl = document.getElementById("insumo_id_existente");
          const rotacionEl = document.getElementById("rotacion_id_existente");

          if (!impresoraEl || !insumoEl || !rotacionEl) {
            console.error("No se encontraron los selectores de configuraci√≥n", {
              impresora: !!impresoraEl,
              insumo: !!insumoEl,
              rotacion: !!rotacionEl,
            });
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-danger">Error: No se encontraron todos los selectores de configuraci√≥n</div>`;
            return;
          }

          // Verificar que los selectores tengan opciones seleccionadas
          const impresoraId = impresoraEl.value;
          const insumoId = insumoEl.value;
          const rotacionId = rotacionEl.value;

          if (!impresoraId || !insumoId || !rotacionId) {
            console.error("Valores de configuraci√≥n faltantes", {
              impresora: !!impresoraId,
              insumo: !!insumoId,
              rotacion: !!rotacionId,
            });
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-warning">Debe seleccionar impresora, tama√±o y rotaci√≥n</div>`;
            return;
          }

          console.log("Generando etiqueta con config:", {
            etiquetaId: etiquetaActualId,
            zplLength: zpl.length,
            impresora: impresoraId,
            insumo: insumoId,
            rotacion: rotacionId,
          });

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("etiqueta_id", etiquetaActualId);
          formData.append("csrfmiddlewaretoken", csrfToken);
          formData.append("zpl_custom", zpl);
          formData.append("impresora_id", impresoraId);
          formData.append("insumo_id", insumoId);
          formData.append("rotacion_id", rotacionId);

          // Mostrar spinner de carga mientras se genera la etiqueta
          const spinnerHTML = `
            <div id="spinner-existente" class="text-center my-3 py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando etiqueta...</span>
              </div>
              <div class="mt-3 fw-bold">Generando etiqueta...</div>
            </div>
          `;
          document.getElementById("target_etiqueta_existente").innerHTML =
            document.getElementById("config_info_existente").outerHTML +
            spinnerHTML;

          // Actualizar la informaci√≥n de configuraci√≥n con los nuevos valores
          try {
            const config = {
              impresora: impresoraEl.options[impresoraEl.selectedIndex].text,
              insumo: insumoEl.options[insumoEl.selectedIndex].text,
              rotacion: rotacionEl.options[rotacionEl.selectedIndex].text,
              impresora_id: impresoraId,
              insumo_id: insumoId,
              rotacion_id: rotacionId,
            };
            actualizarInfoConfigExistente(config);
          } catch (configErr) {
            console.error("Error al actualizar la configuraci√≥n:", configErr);
          }

          // URL para la solicitud
          const url = "{% url 'etiqueta_png' %}";
          console.log("Enviando solicitud a:", url);

          // Enviar la solicitud para generar la etiqueta
          fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest", // Indicar que es una solicitud AJAX
            },
          })
            .then((response) => {
              console.log("Respuesta recibida:", response.status);
              if (!response.ok) {
                throw new Error(
                  `Error HTTP: ${response.status} - ${response.statusText}`
                );
              }
              return response.text();
            })
            .then((html) => {
              console.log("HTML recibido, longitud:", html.length);
              // Verificar si la respuesta contiene alg√∫n error
              if (html.includes("Error") && html.includes("alert-danger")) {
                console.error(
                  "Respuesta contiene error:",
                  html.substring(0, 200) + "..."
                );
                const errorMatch = html.match(
                  /<div class="alert alert-danger">(.*?)<\/div>/
                );
                if (errorMatch && errorMatch[1]) {
                  document.getElementById(
                    "config_info_existente"
                  ).innerHTML = `<div class="alert alert-danger">${errorMatch[1]}</div>`;
                } else {
                  document.getElementById(
                    "config_info_existente"
                  ).innerHTML = `<div class="alert alert-danger">Error al generar la etiqueta</div>`;
                }
                return;
              }

              // Conservar el div de configuraci√≥n y agregar la imagen
              const configInfo = document.getElementById(
                "config_info_existente"
              ).outerHTML;
              document.getElementById("target_etiqueta_existente").innerHTML =
                configInfo + html;
              console.log("Previsualizaci√≥n actualizada correctamente");
            })
            .catch((error) => {
              console.error("Error en fetch de generarEtiqueta:", error);
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al generar la etiqueta: ${error.message}</div>`;
              if (!isPreview) {
                alert("Error al generar la etiqueta: " + error.message);
              }
            });
        } catch (err) {
          console.error("Error general en generarEtiqueta:", err);
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error general: ${err.message}</div>`;
          if (!isPreview) {
            alert("Error al procesar la etiqueta: " + err.message);
          }
        }
      }

      // Funci√≥n para guardar los cambios del ZPL en la base de datos
      function guardarZPL() {
        if (!etiquetaActualId) {
          alert("Por favor, seleccione una etiqueta");
          return;
        }

        const zpl = document.getElementById("zpl_editor").value;
        const nombre = document.getElementById("nombre_etiqueta_actual").value;
        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;

        // Crear un formulario temporal para enviar los datos
        const formData = new FormData();
        formData.append("etiqueta_id", etiquetaActualId);
        formData.append("csrfmiddlewaretoken", csrfToken);
        formData.append("zpl", zpl);
        formData.append("nombre", nombre);

        // Enviar la solicitud para actualizar el ZPL
        fetch("{% url 'actualizar_zpl' %}", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error al actualizar el ZPL");
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert("ZPL actualizado correctamente");
              // Actualizar la previsualizaci√≥n con los cambios guardados
              generarEtiqueta(true);
            } else {
              alert("Error al actualizar el ZPL: " + data.error);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al actualizar el ZPL");
          });
      }

      // Funci√≥n para visualizar la etiqueta con los valores seleccionados
      function visualizarEtiquetaCompleta() {
        try {
          // Obtener los valores de los campos
          const tipoEtiqueta = document.getElementById(
            "tipo_etiqueta_manual"
          ).value;
          const impresoraId = document.getElementById("impresora_id").value;
          const insumoId = document.getElementById("insumo_id").value;
          const rotacionId = document.getElementById("rotacion_id").value;
          const zpl = document.getElementById("etiqueta").value;
          const csrfToken = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          ).value;

          // Validar que tengamos los datos m√≠nimos necesarios
          if (!impresoraId || !insumoId || !rotacionId || !zpl) {
            alert(
              "Por favor seleccione impresora, insumo, rotaci√≥n e ingrese c√≥digo ZPL"
            );
            return;
          }

          // Actualizar la informaci√≥n de configuraci√≥n
          actualizarInfoConfigManual();

          // Mostrar spinner mientras se carga la etiqueta
          const spinnerHTML = `
            <div id="spinner-preview" class="text-center my-3 py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando etiqueta...</span>
              </div>
              <div class="mt-3 fw-bold">Cargando etiqueta...</div>
            </div>
          `;
          document.getElementById("target_etiqueta").innerHTML =
            document.getElementById("config_info_manual").outerHTML +
            spinnerHTML;

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("impresora_id", impresoraId);
          formData.append("insumo_id", insumoId);
          formData.append("rotacion_id", rotacionId);
          formData.append("tipo_etiqueta", tipoEtiqueta);
          formData.append("zpl", zpl);
          formData.append("csrfmiddlewaretoken", csrfToken);
          formData.append("preview", "true"); // Indicar que es una previsualizaci√≥n

          // Enviar la solicitud para visualizar la etiqueta
          fetch("{% url 'visualizar_etiqueta' %}", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
              }
              return response.text();
            })
            .then((html) => {
              // Conservar el div de configuraci√≥n y agregar la imagen
              const configInfo =
                document.getElementById("config_info_manual").outerHTML;
              document.getElementById("target_etiqueta").innerHTML =
                configInfo + html;
            })
            .catch((error) => {
              console.error("Error en visualizarEtiquetaCompleta:", error);
              alert("Error al visualizar la etiqueta: " + error.message);
            });
        } catch (err) {
          console.error("Error general en visualizarEtiquetaCompleta:", err);
          alert("Error al procesar la visualizaci√≥n: " + err.message);
        }
      }

      // Funci√≥n para guardar una nueva etiqueta desde la edici√≥n manual
      function guardarNuevaEtiqueta() {
        // Obtener los valores de los campos
        const nombre = document.getElementById("nombre_etiqueta").value;
        const tipoEtiqueta = document.getElementById(
          "tipo_etiqueta_manual"
        ).value;
        const impresoraId = document.getElementById("impresora_id").value;
        const insumoId = document.getElementById("insumo_id").value;
        const rotacionId = document.getElementById("rotacion_id").value;
        const zpl = document.getElementById("etiqueta").value;
        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;

        // Validar que los campos obligatorios est√©n completos
        if (
          !nombre ||
          !tipoEtiqueta ||
          !impresoraId ||
          !insumoId ||
          !rotacionId ||
          !zpl
        ) {
          alert("Por favor complete todos los campos obligatorios");
          return;
        }

        // Crear un formulario temporal para enviar los datos
        const formData = new FormData();
        formData.append("nombre", nombre);
        formData.append("tipo_etiqueta", tipoEtiqueta);
        formData.append("impresora_id", impresoraId);
        formData.append("insumo_id", insumoId);
        formData.append("rotacion_id", rotacionId);
        formData.append(
          "contenido_zpl",
          document.getElementById("etiqueta").value
        );
        formData.append("csrfmiddlewaretoken", csrfToken);

        // Enviar la solicitud para crear la etiqueta
        fetch("{% url 'crear_etiqueta' %}", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error al crear la etiqueta");
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert(
                "Etiqueta creada correctamente con ID: " + data.etiqueta_id
              );
              // Opcional: Limpiar el formulario o redirigir a la etiqueta creada
              document.getElementById("nombre_etiqueta").value = "";
            } else {
              alert("Error al crear la etiqueta: " + data.error);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al crear la etiqueta");
          });
      }

      // Inicializar cuando la p√°gina cargue
      // Funci√≥n para verificar el estado del entorno
      function verificarEntorno() {
        console.group("Diagn√≥stico del entorno de etiquetas");

        // Verificar componentes cr√≠ticos
        const componentes = {
          "Selector de tipo de etiqueta":
            document.getElementById("tipo_etiqueta"),
          "Selector de etiqueta": document.getElementById("etiqueta_id"),
          "Editor ZPL": document.getElementById("zpl_editor"),
          "Contenedor del editor":
            document.getElementById("zplEditorContainer"),
          "Selector de impresora": document.getElementById(
            "impresora_id_existente"
          ),
          "Selector de insumo": document.getElementById("insumo_id_existente"),
          "Selector de rotaci√≥n": document.getElementById(
            "rotacion_id_existente"
          ),
          "Contenedor de configuraci√≥n": document.getElementById(
            "configExistenteContainer"
          ),
          "√Årea de informaci√≥n de config": document.getElementById(
            "config_info_existente"
          ),
          "Contenedor de previsualizaci√≥n": document.getElementById(
            "target_etiqueta_existente"
          ),
          "Token CSRF": document.querySelector("[name=csrfmiddlewaretoken]"),
        };

        let hayErrores = false;

        // Verificar cada componente
        for (const [nombre, elemento] of Object.entries(componentes)) {
          if (!elemento) {
            console.error(`‚ùå No se encontr√≥: ${nombre}`);
            hayErrores = true;
          } else {
            console.log(`‚úÖ ${nombre} OK`);
          }
        }

        // Verificar URL base
        try {
          const baseUrl = "{% url 'get_zpl' 0 %}";
          if (baseUrl.includes("/0/") || baseUrl.includes("=0")) {
            console.log(`‚úÖ URL base para get_zpl configurada: ${baseUrl}`);
          } else {
            console.warn(
              `‚ö†Ô∏è La URL base no tiene el formato esperado: ${baseUrl}`
            );
            // No lo consideramos como error cr√≠tico
          }
        } catch (e) {
          console.error("‚ùå Error al verificar URL base:", e);
          hayErrores = true;
        }

        // Resultado final
        if (hayErrores) {
          console.error("‚ùå Se encontraron problemas en el entorno");
        } else {
          console.log("‚úÖ Entorno validado correctamente");
        }

        console.groupEnd();
        return !hayErrores;
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ Inicializando aplicaci√≥n de etiquetas");

        // Inicializar el filtro
        filtrarEtiquetas();

        // Verificar el entorno antes de configurar eventos
        const entornoOK = verificarEntorno();

        if (entornoOK) {
          console.log("‚úÖ Configurando eventos de la aplicaci√≥n");

          // Asegurar que el filtro se aplique cuando cambie de pesta√±a
          const manualTab = document.getElementById("manual-tab");
          if (manualTab) {
            manualTab.addEventListener("shown.bs.tab", function () {
              console.log("üîÑ Cambiando a pesta√±a de edici√≥n manual");
              verificarEntorno();
              // Forzar actualizaci√≥n de previsualizaci√≥n
              setTimeout(function () {
                actualizarPrevisualizacionManual();
              }, 100);
            });
          }

          const etiquetasTab = document.getElementById("etiquetas-tab");
          if (etiquetasTab) {
            etiquetasTab.addEventListener("shown.bs.tab", function () {
              console.log("üîÑ Cambiando a pesta√±a de etiquetas existentes");
              filtrarEtiquetas();
              verificarEntorno();
              // Si hay una etiqueta seleccionada, actualizar su previsualizaci√≥n
              const etiquetaIdSelect = document.getElementById("etiqueta_id");
              if (etiquetaIdSelect && etiquetaIdSelect.value) {
                setTimeout(function () {
                  cargarYVisualizarEtiqueta(etiquetaIdSelect.value);
                }, 100);
              }
            });
          }

          // Agregar listeners para actualizaci√≥n en tiempo real en modo manual
          const elementosManual = [
            { id: "etiqueta", evento: "input" },
            { id: "impresora_id", evento: "change" },
            { id: "insumo_id", evento: "change" },
            { id: "rotacion_id", evento: "change" },
            { id: "nombre_etiqueta", evento: "input" },
            { id: "tipo_etiqueta_manual", evento: "change" },
          ];

          elementosManual.forEach((item) => {
            const el = document.getElementById(item.id);
            if (el) {
              el.addEventListener(
                item.evento,
                actualizarPrevisualizacionManual
              );
              console.log(`‚úÖ Listener agregado para ${item.id}`);
            } else {
              console.warn(`‚ö†Ô∏è No se pudo agregar listener para ${item.id}`);
            }
          });

          // Configurar el selector de etiquetas
          const etiquetaIdSelect = document.getElementById("etiqueta_id");
          if (etiquetaIdSelect) {
            etiquetaIdSelect.addEventListener("change", function () {
              const etiquetaId = this.value;
              console.log(`üîÑ Seleccionada etiqueta con ID: ${etiquetaId}`);
              if (etiquetaId) {
                // Mostrar spinner de carga
                const spinnerHTML = `
                  <div id="spinner-carga-etiqueta" class="text-center my-3 py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando etiqueta...</span>
                    </div>
                    <div class="mt-3 fw-bold">Cargando etiqueta...</div>
                  </div>
                `;
                document.getElementById("target_etiqueta_existente").innerHTML =
                  `<div class="alert alert-info mb-3" id="config_info_existente">Cargando etiqueta...</div>` +
                  spinnerHTML;

                // Cargar y visualizar la etiqueta seleccionada
                // La funci√≥n cargarYVisualizarEtiqueta se encargar√° de actualizar la UI
                // y mostrar el campo de nombre con el valor correcto
                cargarYVisualizarEtiqueta(etiquetaId);
              } else {
                // Limpiar la vista si no hay etiqueta seleccionada
                actualizarUIEtiquetaCargada(false);
                etiquetaActualId = null;
                document.getElementById("zpl_editor").value = "";

                // Ya no necesitamos esto porque eliminamos el contenedor
                // document.getElementById("nombre_nueva_etiqueta").value = "";

                etiquetaActualId = null;
                document.getElementById("config_info_existente").innerHTML =
                  "Seleccione una etiqueta para previsualizar";
                document.getElementById("target_etiqueta_existente").innerHTML =
                  '<div class="alert alert-info mb-3" id="config_info_existente">Seleccione una etiqueta para previsualizar</div>';
              }
            });
            console.log("‚úÖ Listener agregado para etiqueta_id");
          } else {
            console.warn("‚ö†Ô∏è No se pudo agregar listener para etiqueta_id");
          }

          // Agregar listeners para actualizaci√≥n en tiempo real en modo etiquetas existentes
          const zplEditor = document.getElementById("zpl_editor");
          if (zplEditor) {
            zplEditor.addEventListener(
              "input",
              actualizarPrevisualizacionExistente
            );
            console.log("‚úÖ Listener agregado para zpl_editor");
          }

          // Agregar listeners a selectores de configuraci√≥n existente
          const elementosExistentes = [
            "impresora_id_existente",
            "insumo_id_existente",
            "rotacion_id_existente",
            "nombre_etiqueta_actual", // Agregamos el campo del nombre
          ];

          elementosExistentes.forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              // Usar el evento "input" para el campo de nombre y "change" para los dem√°s
              const evento =
                id === "nombre_etiqueta_actual" ? "input" : "change";
              el.addEventListener(evento, () => {
                console.log(`üîÑ Cambio en ${id}, generando etiqueta`);

                // Si es el campo de nombre, actualizar tambi√©n la informaci√≥n mostrada
                if (id === "nombre_etiqueta_actual") {
                  actualizarInfoEtiqueta();
                }

                generarEtiqueta(true);
              });
              console.log(
                `‚úÖ Listener agregado para ${id} con evento ${evento}`
              );
            } else {
              console.warn(`‚ö†Ô∏è No se pudo agregar listener para ${id}`);
            }
          });

          // Cargar la previsualizaci√≥n inicial para el modo manual inmediatamente
          console.log("Cargando previsualizaci√≥n inicial para modo manual");
          // Usamos setTimeout para asegurarnos de que todo est√© cargado completamente
          setTimeout(function () {
            actualizarPrevisualizacionManual();
          }, 100);
        } else {
          console.error(
            "‚ùå No se pudieron configurar todos los eventos debido a errores en el entorno"
          );
        }

        // Inicializar el tema
        initTheme();
      });

      // Funci√≥n para cambiar entre tema claro y oscuro
      function toggleTheme() {
        const html = document.documentElement;
        const themeIcon = document.getElementById("theme-icon");

        if (html.getAttribute("data-bs-theme") === "dark") {
          html.setAttribute("data-bs-theme", "light");
          themeIcon.classList.remove("bi-moon-fill");
          themeIcon.classList.add("bi-sun-fill");
          localStorage.setItem("theme", "light");
        } else {
          html.setAttribute("data-bs-theme", "dark");
          themeIcon.classList.remove("bi-sun-fill");
          themeIcon.classList.add("bi-moon-fill");
          localStorage.setItem("theme", "dark");
        }
      }

      // Funci√≥n para inicializar el tema seg√∫n el localStorage
      function initTheme() {
        const savedTheme = localStorage.getItem("theme");
        const themeIcon = document.getElementById("theme-icon");

        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-bs-theme", "dark");
          themeIcon.classList.remove("bi-sun-fill");
          themeIcon.classList.add("bi-moon-fill");
        } else {
          document.documentElement.setAttribute("data-bs-theme", "light");
          themeIcon.classList.remove("bi-moon-fill");
          themeIcon.classList.add("bi-sun-fill");
        }

        // Agregar evento click al bot√≥n de cambio de tema
        document
          .getElementById("theme-toggle")
          .addEventListener("click", toggleTheme);
      }

      // Funci√≥n para obtener el token CSRF
      function getCsrfToken() {
        const csrfTokenElement = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        );
        if (!csrfTokenElement) {
          console.error("Token CSRF no encontrado en el DOM");
          return "";
        }
        return csrfTokenElement.value;
      }

      // Funci√≥n para actualizar la previsualizaci√≥n en tiempo real en modo edici√≥n manual
      function actualizarPrevisualizacionManual() {
        console.log("Iniciando actualizaci√≥n de previsualizaci√≥n manual");
        try {
          // Limpiar el timeout anterior para evitar m√∫ltiples solicitudes
          if (timeoutManual) clearTimeout(timeoutManual);

          // Establecer un nuevo timeout para debounce (300ms)
          timeoutManual = setTimeout(function () {
            console.log("Ejecutando actualizaci√≥n de previsualizaci√≥n manual");

            // Obtener los valores actuales
            const impresoraEl = document.getElementById("impresora_id");
            const insumoEl = document.getElementById("insumo_id");
            const rotacionEl = document.getElementById("rotacion_id");
            const zplEl = document.getElementById("etiqueta");
            const nombreEtiquetaEl = document.getElementById("nombre_etiqueta");
            const tipoEtiquetaEl = document.getElementById(
              "tipo_etiqueta_manual"
            );
            const configInfoEl = document.getElementById("config_info_manual");
            const targetEl = document.getElementById("target_etiqueta");

            // Verificar que los elementos existan
            if (
              !impresoraEl ||
              !insumoEl ||
              !rotacionEl ||
              !zplEl ||
              !tipoEtiquetaEl ||
              !configInfoEl ||
              !targetEl
            ) {
              console.error(
                "Faltan elementos necesarios para la previsualizaci√≥n",
                {
                  impresora: !!impresoraEl,
                  insumo: !!insumoEl,
                  rotacion: !!rotacionEl,
                  zpl: !!zplEl,
                  tipo: !!tipoEtiquetaEl,
                  configInfo: !!configInfoEl,
                  target: !!targetEl,
                }
              );
              return;
            }

            const impresoraId = impresoraEl.value;
            const insumoId = insumoEl.value;
            const rotacionId = rotacionEl.value;
            const zpl = zplEl.value;
            const nombreEtiqueta = nombreEtiquetaEl
              ? nombreEtiquetaEl.value
              : "";
            const tipoEtiqueta = tipoEtiquetaEl.value;

            // Verificar que tengamos todos los datos necesarios, pero permitir continuar con valores por defecto
            let faltanDatos = false;
            let mensajeError = "";

            if (!zpl || zpl.trim() === "") {
              console.warn("ZPL vac√≠o en actualizarPrevisualizacionManual");
              configInfoEl.innerHTML =
                "Ingrese c√≥digo ZPL para previsualizar la etiqueta";
              return;
            }

            // Verificamos cada elemento requerido
            if (!impresoraId) {
              faltanDatos = true;
              mensajeError += "Debe seleccionar una impresora. ";
            }

            if (!insumoId) {
              faltanDatos = true;
              mensajeError += "Debe seleccionar un insumo. ";
            }

            if (!rotacionId) {
              faltanDatos = true;
              mensajeError += "Debe seleccionar una rotaci√≥n. ";
            }

            // Si los datos est√°n incompletos pero tenemos ZPL, continuamos con la previsualizaci√≥n
            // pero mostramos una advertencia
            if (faltanDatos) {
              console.warn(
                "Datos incompletos para la previsualizaci√≥n:",
                mensajeError
              );
              configInfoEl.innerHTML = `<div class="alert alert-warning">${mensajeError} Se usar√°n valores predeterminados.</div>`;
            }

            // Actualizar la informaci√≥n de configuraci√≥n
            actualizarInfoConfigManual();

            // Mostrar spinner de carga mientras se genera la previsualizaci√≥n
            const spinnerHTML = `
              <div id="spinner-manual" class="text-center my-3 py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Generando previsualizaci√≥n...</span>
                </div>
                <div class="mt-3 fw-bold">Generando previsualizaci√≥n...</div>
              </div>
            `;
            targetEl.innerHTML = configInfoEl.outerHTML + spinnerHTML;

            console.log("Generando previsualizaci√≥n para:", {
              nombre: nombreEtiqueta || "Sin nombre",
              tipo: tipoEtiqueta,
              impresora: impresoraId,
              insumo: insumoId,
              rotacion: rotacionId,
            });

            // Crear FormData y enviar la solicitud
            const formData = new FormData();
            const csrfToken = getCsrfToken();

            if (!csrfToken) {
              console.error("No se pudo obtener el token CSRF");
              configInfoEl.innerHTML = `<div class="alert alert-danger">Error: No se pudo obtener el token CSRF</div>`;
              return;
            }

            formData.append("impresora_id", impresoraId);
            formData.append("insumo_id", insumoId);
            formData.append("rotacion_id", rotacionId);
            formData.append("tipo_etiqueta", tipoEtiqueta);
            formData.append("zpl", zpl);
            formData.append("csrfmiddlewaretoken", csrfToken);
            formData.append("preview", "true");

            // Enviar la solicitud para visualizar la etiqueta
            fetch("{% url 'visualizar_etiqueta' %}", {
              method: "POST",
              body: formData,
              headers: {
                "X-Requested-With": "XMLHttpRequest", // Indicar que es una solicitud AJAX
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(
                    `Error HTTP: ${response.status} - ${response.statusText}`
                  );
                }
                return response.text();
              })
              .then((html) => {
                // Conservar el div de configuraci√≥n y agregar la imagen
                const configInfo = configInfoEl.outerHTML;
                targetEl.innerHTML = configInfo + html;
                console.log(
                  "Previsualizaci√≥n manual actualizada correctamente"
                );
              })
              .catch((error) => {
                console.error(
                  "Error en actualizarPrevisualizacionManual:",
                  error
                );
                configInfoEl.innerHTML = `<div class="alert alert-danger">Error al generar la previsualizaci√≥n: ${error.message}</div>`;
              });
          }, 300); // 300ms de debounce
        } catch (err) {
          console.error(
            "Error general en actualizarPrevisualizacionManual:",
            err
          );
          const configInfoEl = document.getElementById("config_info_manual");
          if (configInfoEl) {
            configInfoEl.innerHTML = `<div class="alert alert-danger">Error inesperado: ${err.message}</div>`;
          }
        }
      }

      // Funci√≥n para actualizar la informaci√≥n de configuraci√≥n en modo manual
      function actualizarInfoConfigManual() {
        const impresoraEl = document.getElementById("impresora_id");
        const insumoEl = document.getElementById("insumo_id");
        const rotacionEl = document.getElementById("rotacion_id");
        const tipoEl = document.getElementById("tipo_etiqueta_manual");
        const nombreEl = document.getElementById("nombre_etiqueta");

        const impresoraText =
          impresoraEl.options[impresoraEl.selectedIndex].text;
        const insumoText = insumoEl.options[insumoEl.selectedIndex].text;
        const rotacionText = rotacionEl.options[rotacionEl.selectedIndex].text;
        const tipoText = tipoEl.options[tipoEl.selectedIndex].text;
        const nombreText = nombreEl.value || "Sin nombre";

        configActualManual = {
          impresora: impresoraEl.value,
          insumo: insumoEl.value,
          rotacion: rotacionEl.value,
          tipo: tipoEl.value,
        };

        document.getElementById("config_info_manual").innerHTML =
          `<strong>Nombre:</strong> ${nombreText} | <strong>Tipo:</strong> ${tipoText}<br>` +
          `<strong>Impresora:</strong> ${impresoraText} | <strong>Tama√±o:</strong> ${insumoText} | <strong>Rotaci√≥n:</strong> ${rotacionText}`;
      }

      // Funci√≥n para actualizar la previsualizaci√≥n en tiempo real en modo etiquetas existentes
      function actualizarPrevisualizacionExistente() {
        try {
          // Limpiar el timeout anterior para evitar m√∫ltiples solicitudes
          if (timeoutExistente) clearTimeout(timeoutExistente);

          // Establecer un nuevo timeout para debounce (300ms)
          timeoutExistente = setTimeout(function () {
            if (!etiquetaActualId) {
              console.warn("No hay etiqueta seleccionada");
              document.getElementById("config_info_existente").innerHTML =
                "Seleccione una etiqueta para previsualizar";
              return;
            }

            const zplEditor = document.getElementById("zpl_editor");
            if (!zplEditor) {
              console.error("Editor ZPL no encontrado");
              return;
            }

            const zpl = zplEditor.value;
            if (!zpl || zpl.trim() === "") {
              console.warn("ZPL vac√≠o, no se actualiza la previsualizaci√≥n");
              return;
            }

            console.log(
              "Actualizando previsualizaci√≥n existente para etiqueta ID:",
              etiquetaActualId
            );

            // Actualizar la informaci√≥n de configuraci√≥n
            generarEtiqueta(true);
          }, 300); // 300ms de debounce
        } catch (err) {
          console.error(
            "Error general en actualizarPrevisualizacionExistente:",
            err
          );
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error al actualizar previsualizaci√≥n: ${err.message}</div>`;
        }
      }

      // Funci√≥n para actualizar la informaci√≥n de configuraci√≥n en modo etiquetas existentes
      function actualizarInfoConfigExistente(etiquetaData) {
        try {
          console.log(
            "Actualizando informaci√≥n de configuraci√≥n con datos:",
            etiquetaData
          );

          const configInfoEl = document.getElementById("config_info_existente");
          if (!configInfoEl) {
            console.error("Elemento config_info_existente no encontrado");
            return;
          }

          // Obtener selectores de configuraci√≥n
          const impresoraEl = document.getElementById("impresora_id_existente");
          const insumoEl = document.getElementById("insumo_id_existente");
          const rotacionEl = document.getElementById("rotacion_id_existente");

          // Verificar si tenemos datos completos proporcionados
          if (
            etiquetaData &&
            etiquetaData.impresora &&
            etiquetaData.insumo &&
            etiquetaData.rotacion
          ) {
            // Datos completos proporcionados
            try {
              // Obtener el nombre y tipo de la etiqueta seleccionada
              const etiquetaSelect = document.getElementById("etiqueta_id");
              if (!etiquetaSelect) {
                console.error("Elemento etiqueta_id no encontrado");
                configInfoEl.innerHTML =
                  "Error: Selector de etiquetas no encontrado";
                return;
              }

              if (etiquetaSelect.selectedIndex <= 0) {
                console.warn("No hay etiqueta seleccionada");
                configInfoEl.innerHTML =
                  "Seleccione una etiqueta para ver la configuraci√≥n";
                return;
              }

              const etiquetaOption =
                etiquetaSelect.options[etiquetaSelect.selectedIndex];
              if (!etiquetaOption) {
                console.warn("Opci√≥n de etiqueta no encontrada");
                configInfoEl.innerHTML =
                  "Error al obtener datos de la etiqueta seleccionada";
                return;
              }

              const nombreEtiqueta = etiquetaOption.textContent
                .split("(")[0]
                .trim();
              const tipoEtiqueta =
                etiquetaOption.getAttribute("data-tipo") || "No especificado";

              configInfoEl.innerHTML =
                `<strong>Nombre:</strong> ${nombreEtiqueta} | <strong>Tipo:</strong> ${tipoEtiqueta}<br>` +
                `<strong>Impresora:</strong> ${etiquetaData.impresora} | <strong>Tama√±o:</strong> ${etiquetaData.insumo} | <strong>Rotaci√≥n:</strong> ${etiquetaData.rotacion}`;

              console.log(
                "Configuraci√≥n actualizada con datos proporcionados:",
                {
                  nombre: nombreEtiqueta,
                  tipo: tipoEtiqueta,
                  impresora: etiquetaData.impresora,
                  insumo: etiquetaData.insumo,
                  rotacion: etiquetaData.rotacion,
                }
              );
            } catch (innerErr) {
              console.error("Error al procesar datos de etiqueta:", innerErr);
              configInfoEl.innerHTML = `<div class="alert alert-warning">Error al procesar informaci√≥n de la etiqueta: ${innerErr.message}</div>`;
            }
          } else {
            console.warn(
              "Datos de etiqueta incompletos, intentando construir con selectores"
            );

            // Intentar construir datos a partir de los selectores actuales
            if (
              impresoraEl &&
              insumoEl &&
              rotacionEl &&
              impresoraEl.selectedIndex >= 0 &&
              insumoEl.selectedIndex >= 0 &&
              rotacionEl.selectedIndex >= 0
            ) {
              try {
                // Obtener datos de los selectores actuales
                const impresoraText =
                  impresoraEl.options[impresoraEl.selectedIndex].text;
                const insumoText =
                  insumoEl.options[insumoEl.selectedIndex].text;
                const rotacionText =
                  rotacionEl.options[rotacionEl.selectedIndex].text;

                // Intentar obtener informaci√≥n b√°sica de la etiqueta seleccionada
                const etiquetaSelect = document.getElementById("etiqueta_id");
                if (etiquetaSelect && etiquetaSelect.selectedIndex > 0) {
                  const etiquetaOption =
                    etiquetaSelect.options[etiquetaSelect.selectedIndex];
                  const nombreEtiqueta = etiquetaOption.textContent
                    .split("(")[0]
                    .trim();
                  const tipoEtiqueta =
                    etiquetaOption.getAttribute("data-tipo") ||
                    "No especificado";

                  // Actualizar la configuraci√≥n visual
                  configInfoEl.innerHTML =
                    `<strong>Nombre:</strong> ${nombreEtiqueta} | <strong>Tipo:</strong> ${tipoEtiqueta}<br>` +
                    `<strong>Impresora:</strong> ${impresoraText} | <strong>Tama√±o:</strong> ${insumoText} | <strong>Rotaci√≥n:</strong> ${rotacionText}`;

                  console.log("Configuraci√≥n actualizada desde selectores:", {
                    nombre: nombreEtiqueta,
                    tipo: tipoEtiqueta,
                    impresora: impresoraText,
                    insumo: insumoText,
                    rotacion: rotacionText,
                  });
                } else {
                  configInfoEl.innerHTML =
                    `<strong>Impresora:</strong> ${impresoraText} | <strong>Tama√±o:</strong> ${insumoText} | <strong>Rotaci√≥n:</strong> ${rotacionText}<br>` +
                    `<div class="alert alert-warning">Informaci√≥n de etiqueta no disponible</div>`;
                }
              } catch (selectErr) {
                console.error(
                  "Error al obtener datos de los selectores:",
                  selectErr
                );
                configInfoEl.innerHTML = `<div class="alert alert-warning">Error al procesar selectores: ${selectErr.message}</div>`;
              }
            } else {
              console.warn("No se pudieron obtener valores de los selectores");
              configInfoEl.innerHTML = `<div class="alert alert-warning">Informaci√≥n de configuraci√≥n no disponible</div>`;
            }
          }
        } catch (err) {
          console.error("Error en actualizarInfoConfigExistente:", err);
          const configInfoEl = document.getElementById("config_info_existente");
          if (configInfoEl) {
            configInfoEl.innerHTML = `<div class="alert alert-danger">Error al procesar la configuraci√≥n: ${err.message}</div>`;
          }
        }
      }

      // Funci√≥n para cargar y visualizar autom√°ticamente una etiqueta existente
      function cargarYVisualizarEtiqueta(etiquetaId) {
        try {
          if (!etiquetaId) {
            console.log("No se proporcion√≥ ID de etiqueta");
            return;
          }

          console.log("Cargando y visualizando etiqueta con ID:", etiquetaId);

          // Mostrar y cargar el nombre de la etiqueta seleccionada
          const etiquetaOption = document.querySelector(
            `#etiqueta_id option[value="${etiquetaId}"]`
          );
          if (etiquetaOption) {
            // Asegurar que el UI se actualice para mostrar los campos necesarios
            actualizarUIEtiquetaCargada(true);

            // Cargar el nombre en el campo
            const nombreEtiquetaInput = document.getElementById(
              "nombre_etiqueta_actual"
            );
            if (nombreEtiquetaInput) {
              nombreEtiquetaInput.value = etiquetaOption.textContent.trim();
              console.log(
                "Nombre de etiqueta cargado:",
                etiquetaOption.textContent.trim()
              );
            } else {
              console.error("No se encontr√≥ el campo de nombre de etiqueta");
            }
          }

          // Guardar el ID de la etiqueta seleccionada
          etiquetaActualId = etiquetaId;

          // Construir la URL con URL reversa
          let baseUrl = "{% url 'get_zpl' 0 %}";
          // Verificamos diferentes patrones posibles para reemplazar el ID
          let url;
          if (baseUrl.includes("/0/")) {
            // Patr√≥n: /etiquetas/get_zpl/0/
            url = baseUrl.replace("/0/", `/${etiquetaId}/`);
          } else if (baseUrl.includes("=0")) {
            // Patr√≥n: /etiquetas/get_zpl?id=0
            url = baseUrl.replace("=0", `=${etiquetaId}`);
          } else {
            // Construir la URL manualmente como √∫ltimo recurso
            url = `/etiquetas/get_zpl/${etiquetaId}/`;
          }
          console.log("URL construida:", url);

          // Mostrar spinner mientras se carga la etiqueta
          const spinnerHTML = `
            <div id="spinner-carga-zpl" class="text-center my-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando datos de etiqueta...</span>
              </div>
              <div class="mt-2">Cargando datos de etiqueta...</div>
            </div>
          `;
          // Ya se deber√≠a haber mostrado un spinner en la parte anterior del c√≥digo

          // Configuraci√≥n de la solicitud
          const csrfToken = getCsrfToken();
          const requestOptions = {
            method: "GET",
            headers: {
              Accept: "application/json",
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": csrfToken, // A√±adimos el token CSRF por si acaso
            },
            cache: "no-store", // Evitar cach√©
          };

          // Solicitar el contenido ZPL y su configuraci√≥n
          fetch(url, requestOptions)
            .then((response) => {
              console.log(
                "Respuesta recibida:",
                response.status,
                response.statusText
              );
              if (!response.ok) {
                // Intentar leer cualquier mensaje de error que el servidor haya devuelto
                return response
                  .json()
                  .then((data) => {
                    throw new Error(
                      data.error ||
                        `Error HTTP: ${response.status} - ${response.statusText}`
                    );
                  })
                  .catch((err) => {
                    // Si no se puede parsear como JSON, lanzar el error HTTP original
                    if (err.name === "SyntaxError") {
                      throw new Error(
                        `Error HTTP: ${response.status} - ${response.statusText}`
                      );
                    }
                    throw err; // Re-lanzar el error si ya es un error de nuestro c√≥digo
                  });
              }
              return response.json().catch((err) => {
                console.error("Error al parsear JSON:", err);
                throw new Error("El servidor no devolvi√≥ un JSON v√°lido");
              });
            })
            .then((data) => {
              console.log("ZPL cargado correctamente:", data);

              if (!data || (typeof data.zpl === "undefined" && !data.error)) {
                throw new Error(
                  "La respuesta no contiene datos ZPL ni un mensaje de error"
                );
              }

              if (data.error) {
                throw new Error(`Error del servidor: ${data.error}`);
              }

              // Mostrar el editor ZPL y el bot√≥n de guardar
              document.getElementById("zplEditorContainer").style.display =
                "block";
              document.getElementById("btnGuardarZPL").style.display =
                "inline-block";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "flex";

              // Cargar el ZPL en el editor
              const zplEditor = document.getElementById("zpl_editor");
              if (!zplEditor) {
                throw new Error("No se encontr√≥ el elemento zpl_editor");
              }
              zplEditor.value = data.zpl || "";

              if (!data.zpl || data.zpl.trim() === "") {
                console.warn("El ZPL recibido est√° vac√≠o");
                document.getElementById(
                  "config_info_existente"
                ).innerHTML = `<div class="alert alert-warning">La etiqueta no contiene c√≥digo ZPL</div>`;
                return;
              }

              // Actualizar la informaci√≥n de configuraci√≥n
              if (data.config) {
                console.log("Config recibida:", data.config);

                // Verificar que todos los selectores existen
                const impresoraEl = document.getElementById(
                  "impresora_id_existente"
                );
                const insumoEl = document.getElementById("insumo_id_existente");
                const rotacionEl = document.getElementById(
                  "rotacion_id_existente"
                );

                if (!impresoraEl || !insumoEl || !rotacionEl) {
                  console.error(
                    "No se encontraron todos los selectores de configuraci√≥n"
                  );
                  throw new Error(
                    "No se encontraron los selectores de configuraci√≥n necesarios"
                  );
                }

                // Establecer los valores de los selectores
                impresoraEl.value = data.config.impresora_id;
                insumoEl.value = data.config.insumo_id;
                rotacionEl.value = data.config.rotacion_id;

                actualizarInfoConfigExistente(data.config);
                configActualExistente = {
                  impresora: data.config.impresora_id,
                  insumo: data.config.insumo_id,
                  rotacion: data.config.rotacion_id,
                };

                // Generar previsualizaci√≥n inmediatamente
                generarPreviewInmediato(data.zpl, data.config);
              } else {
                console.warn(
                  "No se recibieron datos de configuraci√≥n completos"
                );
                document.getElementById(
                  "config_info_existente"
                ).innerHTML += `<div class="alert alert-warning">No se recibi√≥ la configuraci√≥n completa de la etiqueta</div>`;
              }
            })
            .catch((error) => {
              console.error("Error al cargar ZPL:", error);
              document.getElementById("zplEditorContainer").style.display =
                "none";
              document.getElementById("btnGuardarZPL").style.display = "none";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "none";
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al cargar el ZPL: ${error.message}</div>`;
            });
        } catch (err) {
          console.error("Error en cargarYVisualizarEtiqueta:", err);
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error general: ${err.message}</div>`;
        }
      }

      // Funci√≥n para generar una vista previa inmediata de la etiqueta
      function generarPreviewInmediato(zpl, config) {
        try {
          if (!zpl || !config) {
            console.error("Faltan datos para generar la previsualizaci√≥n");
            return;
          }

          console.log("Generando previsualizaci√≥n inmediata");

          const csrfToken = getCsrfToken();
          if (!csrfToken) {
            console.error("No se pudo obtener el token CSRF");
            return;
          }

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("etiqueta_id", etiquetaActualId);
          formData.append("csrfmiddlewaretoken", csrfToken);
          formData.append("zpl_custom", zpl);
          formData.append("impresora_id", config.impresora_id);
          formData.append("insumo_id", config.insumo_id);
          formData.append("rotacion_id", config.rotacion_id);

          // URL para la solicitud
          const url = "{% url 'etiqueta_png' %}";

          // Mostrar spinner de carga mientras se genera la etiqueta
          const spinnerHTML = `
            <div id="spinner-preview-inmediato" class="text-center my-3 py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando previsualizaci√≥n...</span>
              </div>
              <div class="mt-3 fw-bold">Generando previsualizaci√≥n...</div>
            </div>
          `;
          document.getElementById("target_etiqueta_existente").innerHTML =
            document.getElementById("config_info_existente").outerHTML +
            spinnerHTML;

          // Enviar la solicitud para generar la etiqueta
          fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `Error HTTP: ${response.status} - ${response.statusText}`
                );
              }
              return response.text();
            })
            .then((html) => {
              // Conservar el div de configuraci√≥n y agregar la imagen
              const configInfo = document.getElementById(
                "config_info_existente"
              ).outerHTML;
              document.getElementById("target_etiqueta_existente").innerHTML =
                configInfo + html;
              console.log("Previsualizaci√≥n inmediata completada");
            })
            .catch((error) => {
              console.error("Error en previsualizaci√≥n inmediata:", error);
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al generar la previsualizaci√≥n: ${error.message}</div>`;
            });
        } catch (err) {
          console.error("Error general en generarPreviewInmediato:", err);
        }
      }

      // Funci√≥n para crear una nueva etiqueta a partir de una etiqueta existente

      // Funci√≥n auxiliar para obtener el token CSRF
      function getCsrfToken() {
        return document.querySelector("[name=csrfmiddlewaretoken]").value;
      }

      // Funci√≥n para actualizar la informaci√≥n de la etiqueta cuando se cambia el nombre
      function actualizarInfoEtiqueta() {
        try {
          // Verificar si hay una etiqueta seleccionada
          if (!etiquetaActualId) {
            console.warn("No hay etiqueta seleccionada para actualizar info");
            return;
          }

          // Obtener el elemento de informaci√≥n de configuraci√≥n
          const configInfoEl = document.getElementById("config_info_existente");
          if (!configInfoEl) {
            console.error("Elemento config_info_existente no encontrado");
            return;
          }

          // Obtener el nombre actualizado
          const nombreEtiquetaInput = document.getElementById(
            "nombre_etiqueta_actual"
          );
          if (!nombreEtiquetaInput) {
            console.error("No se encontr√≥ el campo de nombre de etiqueta");
            return;
          }

          // Obtener la informaci√≥n actual mostrada
          const infoActual = configInfoEl.innerHTML;

          // Actualizar solo la parte del nombre en la informaci√≥n mostrada
          if (infoActual.includes("<strong>Nombre:</strong>")) {
            const nombreActual =
              nombreEtiquetaInput.value.trim() || "Sin nombre";

            // Reemplazar el nombre en la informaci√≥n mostrada usando expresiones regulares
            const nuevoInfo = infoActual.replace(
              /<strong>Nombre:<\/strong>[^|]+/,
              `<strong>Nombre:</strong> ${nombreActual} `
            );

            configInfoEl.innerHTML = nuevoInfo;
            console.log(
              "Informaci√≥n de etiqueta actualizada con el nuevo nombre:",
              nombreActual
            );
          }
        } catch (err) {
          console.error("Error al actualizar informaci√≥n de etiqueta:", err);
        }
      }

      // Funci√≥n original guardarZPL
    </script>
  </body>
</html>
