<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <title>Generador de Etiquetas</title>
    <style>
      /* Estilos responsivos para imágenes */
      #target_etiqueta img,
      #target_etiqueta_existente img {
        max-width: 100%;
        height: auto;
        max-height: 550px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }

      /* Mejoras responsivas */
      .form-control,
      .form-select {
        margin-bottom: 0.5rem;
      }

      /* Ajustes para dispositivos móviles */
      @media (max-width: 768px) {
        .container {
          padding-left: 1rem;
          padding-right: 1rem;
        }

        h1 {
          font-size: 1.75rem;
          margin: 1rem 0;
        }

        .btn {
          width: 100%;
          margin-bottom: 0.5rem;
        }

        .d-flex.gap-2 {
          flex-direction: column;
        }
      }

      /* Estilos para el switch del modo oscuro */
      .theme-switch {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 1030;
      }

      /* Estilos para los temas */
      [data-bs-theme="dark"] {
        --bs-body-bg: #212529;
        --bs-body-color: #e9ecef;
      }

      [data-bs-theme="dark"] .card {
        --bs-card-bg: #343a40;
      }

      [data-bs-theme="dark"] .form-control {
        background-color: #2b3035;
        color: #e9ecef;
        border-color: #495057;
      }

      [data-bs-theme="dark"] .form-select {
        background-color: #2b3035;
        color: #e9ecef;
        border-color: #495057;
      }
    </style>
  </head>
  <body>
    <!-- Botón de cambio de tema -->
    <div class="theme-switch">
      <button class="btn btn-outline-secondary" id="theme-toggle">
        <i class="bi bi-sun-fill" id="theme-icon"></i>
      </button>
    </div>

    <!-- Contenedor para los toasts - margen derecho -->
    <div
      class="toast-container position-fixed top-0 end-0 p-3"
      style="z-index: 1100; margin-top: 20px; width: 350px"
      id="toastContainer"
    ></div>

    <!-- Modal para duplicar etiqueta -->
    <div
      class="modal fade"
      id="modalDuplicarEtiqueta"
      tabindex="-1"
      aria-labelledby="modalDuplicarEtiquetaLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalDuplicarEtiquetaLabel">
              Duplicar etiqueta
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="etiqueta_original_nombre" class="form-label"
                >Etiqueta original:</label
              >
              <input
                type="text"
                class="form-control"
                id="etiqueta_original_nombre"
                disabled
              />
            </div>
            <div class="mb-3">
              <label for="etiqueta_duplicada_nombre" class="form-label"
                >Nombre de la nueva etiqueta:</label
              >
              <input
                type="text"
                class="form-control"
                id="etiqueta_duplicada_nombre"
                required
              />
              <div class="invalid-feedback">El nombre no puede estar vacío</div>
            </div>
            <div class="alert alert-info">
              <small
                >Se duplicará la etiqueta con todos sus datos actuales, pero con
                el nuevo nombre ingresado.</small
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="btnConfirmarDuplicar"
            >
              Duplicar etiqueta
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="container px-4">
      <h1 class="my-4 text-center text-lg-start">
        Sistema de Generación de Etiquetas
      </h1>

      <ul
        class="nav nav-tabs mb-4 flex-column flex-sm-row"
        id="myTab"
        role="tablist"
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active w-100 text-center"
            id="manual-tab"
            data-bs-toggle="tab"
            data-bs-target="#manual"
            type="button"
            role="tab"
            aria-controls="manual"
            aria-selected="true"
          >
            <i class="bi bi-pencil-square"></i> Edición Manual
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link w-100 text-center"
            id="etiquetas-tab"
            data-bs-toggle="tab"
            data-bs-target="#etiquetas"
            type="button"
            role="tab"
            aria-controls="etiquetas"
            aria-selected="false"
          >
            <i class="bi bi-card-list"></i> Etiquetas Existentes
          </button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <!-- Tab de edición manual -->
        <div
          class="tab-pane fade show active"
          id="manual"
          role="tabpanel"
          aria-labelledby="manual-tab"
        >
          <div class="row">
            <div class="col-12 col-lg-6">
              <form
                hx-post="{% url 'etiqueta_png' %}"
                hx-target="#target_etiqueta"
                hx-swap="innerHTML"
              >
                {% csrf_token %}
                <div class="mb-3">
                  <label for="etiqueta" class="form-label">Código ZPL:</label>
                  {% if descripcion_zpl %}
                  <textarea
                    class="form-control"
                    name="etiqueta"
                    id="etiqueta"
                    rows="12"
                  >
{{ descripcion_zpl }}</textarea
                  >
                  {% else %}
                  <textarea
                    class="form-control"
                    name="etiqueta"
                    id="etiqueta"
                    rows="12"
                  >
                    ^XA
                    ^FO50,50^ADN,36,20^FDHola Mundo^FS
                    ^XZ
</textarea
                  >
                  {% endif %}
                </div>
                <div class="row">
                  <div class="col-12 col-sm-6">
                    <div class="mb-3">
                      <label for="variable" class="form-label"
                        >Variables Disponibles:</label
                      >
                      <select class="form-select" name="variable" id="variable">
                        {% for variable in variables %}
                        <option value="{{ variable }}">{{ variable }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <!-- Nueva sección para la creación de etiquetas -->
                  <div class="col-12 col-sm-6">
                    <div class="mb-3">
                      <label for="nombre_etiqueta" class="form-label"
                        >Nombre de etiqueta:</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="nombre_etiqueta"
                        id="nombre_etiqueta"
                        placeholder="Nombre para la etiqueta"
                      />
                    </div>
                  </div>

                  <!-- El selector de idioma para edición manual estará junto con los otros selectores -->

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="tipo_etiqueta_manual" class="form-label"
                        >Tipo:</label
                      >
                      <select
                        class="form-select"
                        name="tipo_etiqueta_manual"
                        id="tipo_etiqueta_manual"
                      >
                        {% for tipo in tipos_etiquetas %}
                        <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="impresora_id" class="form-label"
                        >Impresora:</label
                      >
                      <select
                        class="form-select"
                        name="impresora_id"
                        id="impresora_id"
                      >
                        {% for impresora in impresoras %}
                        <option value="{{ impresora.id }}">
                          {{ impresora.dpi }} DPI
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="insumo_id" class="form-label">Tamaño:</label>
                      <select
                        class="form-select"
                        name="insumo_id"
                        id="insumo_id"
                      >
                        {% for insumo in insumos %}
                        <option value="{{ insumo.id }}">
                          {{ insumo.tamanio }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="rotacion_id" class="form-label"
                        >Rotación:</label
                      >
                      <select
                        class="form-select"
                        name="rotacion_id"
                        id="rotacion_id"
                      >
                        {% for rotacion in rotaciones %}
                        <option value="{{ rotacion.id }}">
                          {{ rotacion.angulo }}°
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <!-- Selector de idioma para edición manual -->
                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="idioma" class="form-label">Idioma:</label>
                      <select
                        class="form-select"
                        name="idioma"
                        id="idioma"
                        onchange="actualizarPrevisualizacionManual()"
                      >
                        {% for idioma in idiomas %}
                        <option value="{{ idioma.codigo }}">
                          {{ idioma.nombre }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                  <button
                    class="btn btn-success"
                    type="button"
                    onclick="guardarNuevaEtiqueta()"
                  >
                    <i class="bi bi-save"></i> Crear etiqueta
                  </button>
                </div>
              </form>
            </div>
            <div class="col-12 col-lg-6 mt-4 mt-lg-0">
              <div id="target_etiqueta" class="text-center">
                <div class="alert alert-info mb-3" id="config_info_manual">
                  Seleccione impresora, tamaño y rotación para previsualizar
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab de etiquetas existentes -->
        <div
          class="tab-pane fade"
          id="etiquetas"
          role="tabpanel"
          aria-labelledby="etiquetas-tab"
        >
          <div class="row">
            <div class="col-12 col-lg-6">
              <form id="etiquetasForm">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="tipo_etiqueta" class="form-label"
                    >Seleccione el tipo:</label
                  >
                  <select
                    class="form-select"
                    name="tipo_etiqueta"
                    id="tipo_etiqueta"
                    onchange="filtrarEtiquetas()"
                  >
                    <option value="">Todos los tipos</option>
                    {% for tipo in tipos_etiquetas %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="etiqueta_id" class="form-label"
                    >Seleccione una etiqueta:</label
                  >
                  <select
                    class="form-select"
                    name="etiqueta_id"
                    id="etiqueta_id"
                  >
                    <option value="">-- Seleccione una etiqueta --</option>
                    {% if etiquetas %} {% for etiqueta in etiquetas %}
                    <option
                      value="{{ etiqueta.id }}"
                      data-tipo="{{ etiqueta.tipo_etiqueta }}"
                    >
                      {{ etiqueta.nombre }}
                    </option>
                    {% endfor %} {% else %}
                    <option value="">No hay etiquetas disponibles</option>
                    {% endif %}
                  </select>
                </div>

                <div class="mb-3" id="zplEditorContainer" style="display: none">
                  <label for="zpl_editor" class="form-label">Código ZPL:</label>
                  <textarea
                    class="form-control"
                    name="zpl_editor"
                    id="zpl_editor"
                    rows="12"
                  ></textarea>
                </div>

                <div
                  class="row"
                  id="configExistenteContainer"
                  style="display: none"
                >
                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="impresora_id_existente" class="form-label"
                        >Impresora:</label
                      >
                      <select
                        class="form-select"
                        name="impresora_id_existente"
                        id="impresora_id_existente"
                      >
                        {% for impresora in impresoras %}
                        <option value="{{ impresora.id }}">
                          {{ impresora.dpi }} DPI
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="insumo_id_existente" class="form-label"
                        >Tamaño:</label
                      >
                      <select
                        class="form-select"
                        name="insumo_id_existente"
                        id="insumo_id_existente"
                      >
                        {% for insumo in insumos %}
                        <option value="{{ insumo.id }}">
                          {{ insumo.tamanio }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="rotacion_id_existente" class="form-label"
                        >Rotación:</label
                      >
                      <select
                        class="form-select"
                        name="rotacion_id_existente"
                        id="rotacion_id_existente"
                      >
                        {% for rotacion in rotaciones %}
                        <option value="{{ rotacion.id }}">
                          {{ rotacion.angulo }}°
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>

                  <!-- Selector de idioma para etiquetas existentes -->
                  <div class="col-12 col-sm-4">
                    <div class="mb-3">
                      <label for="idioma_existente" class="form-label"
                        >Idioma:</label
                      >
                      <select
                        class="form-select"
                        name="idioma"
                        id="idioma_existente"
                      >
                        {% for idioma in idiomas %}
                        <option value="{{ idioma.codigo }}">
                          {{ idioma.nombre }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <div
                  class="mb-3"
                  id="nombreActualContainer"
                  style="display: none"
                >
                  <label for="nombre_etiqueta_actual" class="form-label"
                    >Nombre de la etiqueta:</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    name="nombre_etiqueta_actual"
                    id="nombre_etiqueta_actual"
                    placeholder="Nombre de la etiqueta actual"
                  />
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                  <button
                    class="btn btn-success me-2"
                    type="button"
                    id="btnGuardarZPL"
                    onclick="guardarZPL()"
                    style="display: none"
                  >
                    <i class="bi bi-save"></i> Guardar cambios
                  </button>
                  <button
                    class="btn btn-info"
                    type="button"
                    id="btnDuplicarEtiqueta"
                    onclick="duplicarEtiqueta()"
                    style="display: none"
                  >
                    <i class="bi bi-copy"></i> Duplicar etiqueta
                  </button>
                </div>
              </form>
            </div>
            <div class="col-12 col-lg-6 mt-4 mt-lg-0">
              <div id="target_etiqueta_existente" class="text-center">
                <div class="alert alert-info mb-3" id="config_info_existente">
                  Seleccione una etiqueta para previsualizar
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      // Variables globales para la gestión de etiquetas
      let etiquetaActualId = null;
      let timeoutManual = null; // Variable para controlar el debounce en edición manual
      let timeoutExistente = null; // Variable para controlar el debounce en etiquetas existentes
      let timeoutNombre = null; // Variable para controlar el debounce específico del campo nombre

      // Función para actualizar la UI cuando se carga una etiqueta
      function actualizarUIEtiquetaCargada(mostrar) {
        try {
          // Elementos que deben mostrarse/ocultarse cuando se carga una etiqueta
          const elementosUI = [
            "zplEditorContainer",
            "btnGuardarZPL",
            "btnDuplicarEtiqueta", // Incluir botón de duplicar
            "configExistenteContainer",
            "nombreActualContainer", // Incluir el contenedor del nombre
          ];

          // Mostrar u ocultar elementos según el parámetro
          elementosUI.forEach((id) => {
            const elemento = document.getElementById(id);
            if (elemento) {
              elemento.style.display = mostrar
                ? id === "configExistenteContainer"
                  ? "flex"
                  : "block"
                : "none";
              console.log(
                `${mostrar ? "Mostrando" : "Ocultando"} elemento: ${id}`
              );
            } else {
              console.warn(`Elemento no encontrado: ${id}`);
            }
          });

          // Si no se muestra, limpiar valores
          if (!mostrar) {
            const zplEditor = document.getElementById("zpl_editor");
            const nombreEtiquetaInput = document.getElementById(
              "nombre_etiqueta_actual"
            );

            if (zplEditor) zplEditor.value = "";
            if (nombreEtiquetaInput) nombreEtiquetaInput.value = "";

            etiquetaActualId = null;
          }
        } catch (err) {
          console.error("Error en actualizarUIEtiquetaCargada:", err);
        }
      }

      let configActualManual = {
        impresora: null,
        insumo: null,
        rotacion: null,
      };
      let configActualExistente = {
        impresora: null,
        insumo: null,
        rotacion: null,
        idioma: "es", // Idioma español por defecto
      };

      // Función para filtrar las etiquetas según el tipo seleccionado
      function filtrarEtiquetas() {
        try {
          const tipoSeleccionado =
            document.getElementById("tipo_etiqueta").value;
          const selectEtiquetas = document.getElementById("etiqueta_id");
          const opciones = selectEtiquetas.options;

          // Reiniciar el select de etiquetas
          selectEtiquetas.selectedIndex = 0;
          document.getElementById("zplEditorContainer").style.display = "none";
          document.getElementById("btnGuardarZPL").style.display = "none";
          document.getElementById("configExistenteContainer").style.display =
            "none";

          // Ocultar también el contenedor del nombre de la etiqueta
          const nombreActualContainer = document.getElementById(
            "nombreActualContainer"
          );
          if (nombreActualContainer) {
            nombreActualContainer.style.display = "none";
            console.log(
              "Ocultando contenedor de nombre al cambiar tipo de etiqueta"
            );
          }

          document.getElementById("zpl_editor").value = "";
          etiquetaActualId = null;

          // Restablecer el div de información
          document.getElementById("config_info_existente").innerHTML =
            "Seleccione una etiqueta para previsualizar";

          document.getElementById("target_etiqueta_existente").innerHTML =
            '<div class="alert alert-info mb-3" id="config_info_existente">Seleccione una etiqueta para previsualizar</div>';

          // Mostrar/ocultar opciones según el tipo seleccionado
          let opcionesVisibles = 0;
          for (let i = 1; i < opciones.length; i++) {
            const opcion = opciones[i];
            const tipoEtiqueta = opcion.getAttribute("data-tipo");

            if (!tipoSeleccionado || tipoEtiqueta === tipoSeleccionado) {
              opcion.style.display = "";
              opcionesVisibles++;
            } else {
              opcion.style.display = "none";
            }
          }

          // Verificar si hay etiquetas disponibles para el tipo seleccionado
          if (opcionesVisibles === 0 && tipoSeleccionado) {
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-warning">No hay etiquetas disponibles para el tipo: ${tipoSeleccionado}</div>`;
          }
        } catch (err) {
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error al filtrar etiquetas: ${err.message}</div>`;
        }
      }

      // Función para cargar el ZPL de una etiqueta seleccionada
      function cargarZPL(etiquetaId) {
        try {
          if (!etiquetaId) {
            // Ocultar todos los elementos UI
            actualizarUIEtiquetaCargada(false);

            // Limpiar campos
            document.getElementById("zpl_editor").value = "";
            document.getElementById("nombre_etiqueta_actual").value = "";
            // Ya no necesitamos esto porque eliminamos el contenedor
            // document.getElementById("nombre_nueva_etiqueta").value = "";
            etiquetaActualId = null;

            // Resetear mensajes
            document.getElementById("config_info_existente").innerHTML =
              "Seleccione una etiqueta para previsualizar";
            document.getElementById("target_etiqueta_existente").innerHTML =
              '<div class="alert alert-info mb-3" id="config_info_existente">Seleccione una etiqueta para previsualizar</div>';
            return;
          }

          // Guardar el ID de la etiqueta seleccionada
          etiquetaActualId = etiquetaId;

          // Obtener el nombre actual de la etiqueta seleccionada
          const etiquetaOption = document.querySelector(
            `#etiqueta_id option[value="${etiquetaId}"]`
          );
          const nombreEtiqueta = etiquetaOption ? etiquetaOption.text : "";

          // Mostrar todos los elementos UI para edición
          actualizarUIEtiquetaCargada(true);

          // Establecer el nombre actual de la etiqueta
          document.getElementById("nombre_etiqueta_actual").value =
            nombreEtiqueta;

          // Mostrar mensaje de carga
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-info">
              <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              Cargando etiqueta...
            </div>`;

          // Construir la URL con URL reversa para asegurar que la ruta es correcta
          const baseUrl = "{% url 'get_zpl' 0 %}";
          // Verificar que la URL base se construye correctamente
          if (!baseUrl || baseUrl === "{% url 'get_zpl' 0 %}") {
            throw new Error(
              "Error al construir la URL. No se pudo utilizar la etiqueta de plantilla."
            );
          }

          const url = baseUrl.replace("/0/", `/${etiquetaId}/`);
          console.log("URL construida:", url);

          // Configuración de la solicitud
          const requestOptions = {
            method: "GET",
            headers: {
              Accept: "application/json",
              "X-Requested-With": "XMLHttpRequest",
            },
            cache: "no-store", // Evitar caché
          };

          // Solicitar el contenido ZPL de la etiqueta seleccionada y sus datos de configuración
          fetch(url, requestOptions)
            .then((response) => {
              console.log(
                "Respuesta recibida:",
                response.status,
                response.statusText
              );
              if (!response.ok) {
                throw new Error(
                  `Error HTTP: ${response.status} - ${response.statusText}`
                );
              }
              return response.json().catch((err) => {
                console.error("Error al parsear JSON:", err);
                throw new Error("El servidor no devolvió un JSON válido");
              });
            })
            .then((data) => {
              console.log("ZPL cargado correctamente:", data);

              if (!data || (typeof data.zpl === "undefined" && !data.error)) {
                throw new Error(
                  "La respuesta no contiene datos ZPL ni un mensaje de error"
                );
              }

              if (data.error) {
                throw new Error(`Error del servidor: ${data.error}`);
              }

              // Mostrar el editor ZPL y el botón de guardar
              document.getElementById("zplEditorContainer").style.display =
                "block";
              document.getElementById("btnGuardarZPL").style.display =
                "inline-block";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "flex";

              // Cargar el ZPL en el editor
              const zplEditor = document.getElementById("zpl_editor");
              if (!zplEditor) {
                throw new Error("No se encontró el elemento zpl_editor");
              }
              zplEditor.value = data.zpl || "";

              if (!data.zpl || data.zpl.trim() === "") {
                console.warn("El ZPL recibido está vacío");
                document.getElementById(
                  "config_info_existente"
                ).innerHTML = `<div class="alert alert-warning">La etiqueta no contiene código ZPL</div>`;
                return;
              }

              // Actualizar la información de configuración
              if (data.config) {
                console.log("Config recibida:", data.config);

                // Verificar que todos los selectores existen
                const impresoraEl = document.getElementById(
                  "impresora_id_existente"
                );
                const insumoEl = document.getElementById("insumo_id_existente");
                const rotacionEl = document.getElementById(
                  "rotacion_id_existente"
                );

                if (!impresoraEl || !insumoEl || !rotacionEl) {
                  console.error(
                    "No se encontraron todos los selectores de configuración"
                  );
                  throw new Error(
                    "No se encontraron los selectores de configuración necesarios"
                  );
                }

                // Establecer los valores de los selectores
                impresoraEl.value = data.config.impresora_id;
                insumoEl.value = data.config.insumo_id;
                rotacionEl.value = data.config.rotacion_id;

                actualizarInfoConfigExistente(data.config);
                configActualExistente = {
                  impresora: data.config.impresora_id,
                  insumo: data.config.insumo_id,
                  rotacion: data.config.rotacion_id,
                };

                // Generar previsualización inmediatamente
                generarPreviewInmediato(data.zpl, data.config);
              } else {
                console.warn(
                  "No se recibieron datos de configuración completos"
                );
                document.getElementById(
                  "config_info_existente"
                ).innerHTML += `<div class="alert alert-warning">No se recibió la configuración completa de la etiqueta</div>`;
              }
            })
            .catch((error) => {
              console.error("Error al cargar ZPL:", error);
              document.getElementById("zplEditorContainer").style.display =
                "none";
              document.getElementById("btnGuardarZPL").style.display = "none";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "none";
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al cargar el ZPL: ${error.message}</div>`;
            });
        } catch (err) {
          console.error("Error en cargarZPL:", err);
          // Ocultar todos los elementos UI
          actualizarUIEtiquetaCargada(false);
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error general: ${err.message}</div>`;
        }
      }

      // Función para generar la etiqueta with el ZPL actual
      function generarEtiqueta(isPreview = false) {
        try {
          if (!etiquetaActualId) {
            if (!isPreview) {
              mostrarToast(
                "Por favor, seleccione una etiqueta",
                "warning",
                4000
              );
            }
            console.warn("No hay etiqueta seleccionada");
            return;
          }

          // Obtener y validar el ZPL
          const zplEditor = document.getElementById("zpl_editor");
          if (!zplEditor) {
            console.error("Elemento zpl_editor no encontrado");
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-danger">Error: Editor ZPL no encontrado</div>`;
            return;
          }

          const zpl = zplEditor.value;
          if (!zpl || zpl.trim() === "") {
            console.warn("ZPL vacío en generarEtiqueta");
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-warning">El código ZPL no puede estar vacío</div>`;
            return;
          }

          // Obtener el token CSRF
          const csrfTokenElement = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          );
          if (!csrfTokenElement) {
            console.error("Token CSRF no encontrado");
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-danger">Error: Token CSRF no encontrado</div>`;
            return;
          }
          const csrfToken = csrfTokenElement.value;

          // Obtener configuración seleccionada
          const impresoraEl = document.getElementById("impresora_id_existente");
          const insumoEl = document.getElementById("insumo_id_existente");
          const rotacionEl = document.getElementById("rotacion_id_existente");

          if (!impresoraEl || !insumoEl || !rotacionEl) {
            console.error("No se encontraron los selectores de configuración", {
              impresora: !!impresoraEl,
              insumo: !!insumoEl,
              rotacion: !!rotacionEl,
            });
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-danger">Error: No se encontraron todos los selectores de configuración</div>`;
            return;
          }

          // Verificar que los selectores tengan opciones seleccionadas
          const impresoraId = impresoraEl.value;
          const insumoId = insumoEl.value;
          const rotacionId = rotacionEl.value;

          if (!impresoraId || !insumoId || !rotacionId) {
            console.error("Valores de configuración faltantes", {
              impresora: !!impresoraId,
              insumo: !!insumoId,
              rotacion: !!rotacionId,
            });
            document.getElementById(
              "config_info_existente"
            ).innerHTML = `<div class="alert alert-warning">Debe seleccionar impresora, tamaño y rotación</div>`;
            return;
          }

          console.log("Generando etiqueta con config:", {
            etiquetaId: etiquetaActualId,
            zplLength: zpl.length,
            impresora: impresoraId,
            insumo: insumoId,
            rotacion: rotacionId,
          });

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("etiqueta_id", etiquetaActualId);
          formData.append("csrfmiddlewaretoken", csrfToken);
          formData.append("zpl_custom", zpl);
          formData.append("impresora_id", impresoraId);
          formData.append("insumo_id", insumoId);
          formData.append("rotacion_id", rotacionId);

          // Incluir el idioma seleccionado
          const idiomaSelect = document.getElementById("idioma_existente");
          if (idiomaSelect) {
            formData.append("idioma", idiomaSelect.value);
            console.log(
              "Idioma seleccionado para generación:",
              idiomaSelect.value
            );
          } else {
            // Si no hay selector, usar español por defecto
            formData.append("idioma", "es");
            console.warn(
              "No se encontró selector de idioma, usando 'es' por defecto"
            );
          }

          // Mostrar spinner de carga mientras se genera la etiqueta
          const spinnerHTML = `
            <div id="spinner-existente" class="text-center my-3 py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando etiqueta...</span>
              </div>
              <div class="mt-3 fw-bold">Generando etiqueta...</div>
            </div>
          `;
          document.getElementById("target_etiqueta_existente").innerHTML =
            document.getElementById("config_info_existente").outerHTML +
            spinnerHTML;

          // Actualizar la información de configuración con los nuevos valores
          try {
            // Obtener el idioma seleccionado
            const idiomaEl = document.getElementById("idioma_existente");
            const idiomaId = idiomaEl ? idiomaEl.value : "es";
            const idiomaText = idiomaEl
              ? idiomaEl.options[idiomaEl.selectedIndex].text
              : "Español";

            const config = {
              impresora: impresoraEl.options[impresoraEl.selectedIndex].text,
              insumo: insumoEl.options[insumoEl.selectedIndex].text,
              rotacion: rotacionEl.options[rotacionEl.selectedIndex].text,
              impresora_id: impresoraId,
              insumo_id: insumoId,
              rotacion_id: rotacionId,
              idioma: idiomaId,
              idioma_text: idiomaText,
            };
            actualizarInfoConfigExistente(config);
          } catch (configErr) {
            console.error("Error al actualizar la configuración:", configErr);
          }

          // URL para la solicitud
          const url = "{% url 'etiqueta_png' %}";
          console.log("Enviando solicitud a:", url);

          // Enviar la solicitud para generar la etiqueta
          fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest", // Indicar que es una solicitud AJAX
            },
          })
            .then((response) => {
              console.log("Respuesta recibida:", response.status);
              if (!response.ok) {
                throw new Error(
                  `Error HTTP: ${response.status} - ${response.statusText}`
                );
              }
              return response.text();
            })
            .then((html) => {
              console.log("HTML recibido, longitud:", html.length);
              // Verificar si la respuesta contiene algún error
              if (html.includes("Error") && html.includes("alert-danger")) {
                console.error(
                  "Respuesta contiene error:",
                  html.substring(0, 200) + "..."
                );
                const errorMatch = html.match(
                  /<div class="alert alert-danger">(.*?)<\/div>/
                );
                if (errorMatch && errorMatch[1]) {
                  document.getElementById(
                    "config_info_existente"
                  ).innerHTML = `<div class="alert alert-danger">${errorMatch[1]}</div>`;
                } else {
                  document.getElementById(
                    "config_info_existente"
                  ).innerHTML = `<div class="alert alert-danger">Error al generar la etiqueta</div>`;
                }
                return;
              }

              // Obtener el nombre actual antes de reemplazar el contenido
              const nombreActual =
                document
                  .getElementById("nombre_etiqueta_actual")
                  .value.trim() || "Sin nombre";

              // Conservar el div de configuración y agregar la imagen
              const configInfo = document.getElementById(
                "config_info_existente"
              ).outerHTML;
              document.getElementById("target_etiqueta_existente").innerHTML =
                configInfo + html;

              // Asegurarse de que el nombre mostrado sea el actualizado
              actualizarInfoEtiqueta();
              console.log(
                "Previsualización actualizada correctamente con nombre:",
                nombreActual
              );
            })
            .catch((error) => {
              console.error("Error en fetch de generarEtiqueta:", error);
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al generar la etiqueta: ${error.message}</div>`;
              if (!isPreview) {
                mostrarToast(
                  "Error al generar la etiqueta: " + error.message,
                  "error",
                  4000
                );
              }
            });
        } catch (err) {
          console.error("Error general en generarEtiqueta:", err);
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error general: ${err.message}</div>`;
          if (!isPreview) {
            mostrarToast(
              "Error al procesar la etiqueta: " + err.message,
              "error",
              4000
            );
          }
        }
      }

      // Función para guardar los cambios del ZPL en la base de datos
      function guardarZPL() {
        if (!etiquetaActualId) {
          mostrarToast("Por favor, seleccione una etiqueta", "warning", 4000);
          return;
        }

        const zpl = document.getElementById("zpl_editor").value;
        const nombreInput = document.getElementById("nombre_etiqueta_actual");
        const nombre = nombreInput.value.trim();
        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;

        // Validar que el nombre esté completo
        if (
          !validarCampoRequerido(
            nombreInput,
            "El nombre de la etiqueta es obligatorio"
          )
        ) {
          return;
        }

        // Crear un formulario temporal para enviar los datos
        const formData = new FormData();
        formData.append("etiqueta_id", etiquetaActualId);
        formData.append("csrfmiddlewaretoken", csrfToken);
        formData.append("zpl", zpl);
        formData.append("nombre", nombre);

        // Enviar la solicitud para actualizar el ZPL
        fetch("{% url 'actualizar_zpl' %}", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            // Siempre intentar obtener el JSON, incluso en caso de error HTTP
            return response.json().then((data) => {
              if (!response.ok) {
                // Si tenemos un JSON con error, usarlo para el mensaje de error
                throw {
                  message: data.error || "Error al actualizar el ZPL",
                  errorType: data.errorType,
                  data: data,
                };
              }
              return data;
            });
          })
          .then((data) => {
            if (data.success) {
              // Mostrar toast de éxito
              mostrarToast("ZPL actualizado correctamente", "success", 4000);

              // Actualizar la previsualización con los cambios guardados
              generarEtiqueta(true);
            } else {
              mostrarToast(
                "Error al actualizar el ZPL: " + data.error,
                "error",
                4000
              );
            }
          })
          .catch((error) => {
            console.error("Error:", error);

            // Verificar si es un error de duplicado
            const errorMsg = error.message || error.toString();
            if (
              error.errorType === "duplicate" ||
              errorMsg.includes("Ya existe otra etiqueta con el nombre")
            ) {
              // Mostrar toast de error por duplicado
              mostrarToast(errorMsg, "error", 4000);

              // Resaltar el campo de nombre
              nombreInput.classList.add("is-invalid");
              let feedbackEl = nombreInput.nextElementSibling;
              if (
                !feedbackEl ||
                !feedbackEl.classList.contains("invalid-feedback")
              ) {
                feedbackEl = document.createElement("div");
                feedbackEl.className = "invalid-feedback";
                feedbackEl.textContent =
                  "Ya existe otra etiqueta con este nombre para el mismo tipo. Por favor use otro nombre.";
                nombreInput.parentNode.insertBefore(
                  feedbackEl,
                  nombreInput.nextSibling
                );
              }
            } else {
              // Error genérico
              mostrarToast(
                "Error al actualizar el ZPL: " + error.message,
                "error",
                4000
              );
            }
          });
      }

      // Función para duplicar la etiqueta actual
      function duplicarEtiqueta() {
        if (!etiquetaActualId) {
          mostrarToast(
            "Por favor, seleccione una etiqueta primero",
            "warning",
            4000
          );
          return;
        }

        // Obtener el nombre actual para sugerir uno nuevo
        const nombreActual = document
          .getElementById("nombre_etiqueta_actual")
          .value.trim();

        // Configurar el modal con los datos actuales
        const etiquetaOriginalInput = document.getElementById(
          "etiqueta_original_nombre"
        );
        const etiquetaDuplicadaInput = document.getElementById(
          "etiqueta_duplicada_nombre"
        );

        // Mostrar el nombre actual en el campo de etiqueta original
        if (etiquetaOriginalInput) {
          etiquetaOriginalInput.value = nombreActual;
        }

        // Sugerir un nombre para la nueva etiqueta
        if (etiquetaDuplicadaInput) {
          etiquetaDuplicadaInput.value = nombreActual + " - Copia";
          // Quitar cualquier estado inválido previo
          etiquetaDuplicadaInput.classList.remove("is-invalid");
        }

        // Mostrar el modal
        const modalDuplicar = new bootstrap.Modal(
          document.getElementById("modalDuplicarEtiqueta")
        );
        modalDuplicar.show();

        // Enfoque en el campo de nombre nuevo
        etiquetaDuplicadaInput.focus();
        etiquetaDuplicadaInput.select();

        // Configurar el botón de confirmación
        const btnConfirmar = document.getElementById("btnConfirmarDuplicar");

        // Limpiar los eventos previos del botón para evitar duplicaciones
        btnConfirmar.replaceWith(btnConfirmar.cloneNode(true));

        // Obtener la referencia al nuevo botón (después del cloneNode)
        const btnConfirmarNuevo = document.getElementById(
          "btnConfirmarDuplicar"
        );

        // Agregar un único listener al botón
        btnConfirmarNuevo.addEventListener("click", function () {
          // Obtener el nuevo nombre desde el input del modal
          const nuevoNombre = etiquetaDuplicadaInput.value.trim();

          // Validar que el nombre no esté vacío
          if (!nuevoNombre || nuevoNombre === "") {
            etiquetaDuplicadaInput.classList.add("is-invalid");
            return;
          }

          // Deshabilitar el botón para evitar doble clic
          btnConfirmarNuevo.disabled = true;

          // Cerrar el modal
          modalDuplicar.hide();

          // Mostrar un toast de "Duplicando..."
          mostrarToast("Duplicando etiqueta...", "info", 2000);

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("etiqueta_id", etiquetaActualId);
          formData.append("nuevo_nombre", nuevoNombre);
          formData.append(
            "csrfmiddlewaretoken",
            document.querySelector("[name=csrfmiddlewaretoken]").value
          );

          // Enviar la solicitud para duplicar la etiqueta
          fetch("{% url 'duplicar_etiqueta' %}", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                mostrarToast(
                  `Etiqueta duplicada correctamente como "${nuevoNombre}"`,
                  "success",
                  4000
                );

                // Recargar la página para ver la nueva etiqueta
                setTimeout(() => {
                  location.reload();
                }, 1500);
              } else {
                // Habilitar el botón nuevamente en caso de error
                btnConfirmarNuevo.disabled = false;

                // Verificar si es error de nombre duplicado
                if (data.error && data.error.includes("Ya existe")) {
                  mostrarToast(
                    "Ya existe una etiqueta con ese nombre",
                    "error",
                    4000
                  );
                } else {
                  mostrarToast(
                    "Error al duplicar la etiqueta: " + data.error,
                    "error",
                    4000
                  );
                }
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              mostrarToast("Error al duplicar la etiqueta", "error", 4000);
              // Habilitar el botón nuevamente en caso de error
              btnConfirmarNuevo.disabled = false;
            });
        });

        // También permitir envío con Enter en el campo de texto
        etiquetaDuplicadaInput.onkeydown = function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            // Usar la referencia al nuevo botón
            btnConfirmarNuevo.click();
          }
        };
      }

      // Función para visualizar la etiqueta con los valores seleccionados
      function visualizarEtiquetaCompleta() {
        try {
          // Obtener los valores de los campos
          const tipoEtiqueta = document.getElementById(
            "tipo_etiqueta_manual"
          ).value;
          const impresoraId = document.getElementById("impresora_id").value;
          const insumoId = document.getElementById("insumo_id").value;
          const rotacionId = document.getElementById("rotacion_id").value;
          const zpl = document.getElementById("etiqueta").value;
          const csrfToken = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          ).value;

          // Validar que tengamos los datos mínimos necesarios
          if (!impresoraId || !insumoId || !rotacionId || !zpl) {
            mostrarToast(
              "Por favor seleccione impresora, insumo, rotación e ingrese código ZPL",
              "warning",
              4000
            );
            return;
          }

          // Actualizar la información de configuración
          actualizarInfoConfigManual();

          // Mostrar spinner mientras se carga la etiqueta
          const spinnerHTML = `
            <div id="spinner-preview" class="text-center my-3 py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando etiqueta...</span>
              </div>
              <div class="mt-3 fw-bold">Cargando etiqueta...</div>
            </div>
          `;
          document.getElementById("target_etiqueta").innerHTML =
            document.getElementById("config_info_manual").outerHTML +
            spinnerHTML;

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("impresora_id", impresoraId);
          formData.append("insumo_id", insumoId);
          formData.append("rotacion_id", rotacionId);
          formData.append("tipo_etiqueta", tipoEtiqueta);
          formData.append("zpl", zpl);
          formData.append("csrfmiddlewaretoken", csrfToken);
          formData.append("preview", "true"); // Indicar que es una previsualización

          // Incluir el idioma seleccionado
          const idiomaSelect = document.getElementById("idioma");
          if (idiomaSelect) {
            formData.append("idioma", idiomaSelect.value);
            console.log(
              "Idioma seleccionado para edición manual:",
              idiomaSelect.value
            );
          } else {
            console.warn(
              "No se encontró el selector de idioma para edición manual"
            );
          }

          // Enviar la solicitud para visualizar la etiqueta
          fetch("{% url 'visualizar_etiqueta' %}", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
              }
              return response.text();
            })
            .then((html) => {
              // Conservar el div de configuración y agregar la imagen
              const configInfo =
                document.getElementById("config_info_manual").outerHTML;
              document.getElementById("target_etiqueta").innerHTML =
                configInfo + html;
            })
            .catch((error) => {
              console.error("Error en visualizarEtiquetaCompleta:", error);
              mostrarToast(
                "Error al visualizar la etiqueta: " + error.message,
                "error",
                4000
              );
            });
        } catch (err) {
          console.error("Error general en visualizarEtiquetaCompleta:", err);
          mostrarToast(
            "Error al procesar la visualización: " + err.message,
            "error",
            4000
          );
        }
      }

      // Función para guardar una nueva etiqueta desde la edición manual
      function guardarNuevaEtiqueta() {
        // Obtener los valores de los campos
        const nombreInput = document.getElementById("nombre_etiqueta");
        const nombre = nombreInput.value.trim();
        const tipoEtiqueta = document.getElementById(
          "tipo_etiqueta_manual"
        ).value;
        const impresoraId = document.getElementById("impresora_id").value;
        const insumoId = document.getElementById("insumo_id").value;
        const rotacionId = document.getElementById("rotacion_id").value;
        const zpl = document.getElementById("etiqueta").value;
        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;

        // Validar que el nombre esté completo (único campo requerido)
        if (
          !validarCampoRequerido(
            nombreInput,
            "El nombre de la etiqueta es obligatorio"
          )
        ) {
          return;
        }

        // Validar que los demás campos obligatorios estén completos
        if (!tipoEtiqueta || !impresoraId || !insumoId || !rotacionId || !zpl) {
          // Para estos campos usamos el toast
          mostrarToast(
            "Por favor complete todos los campos obligatorios",
            "warning",
            4000
          );
          return;
        }

        // Crear un formulario temporal para enviar los datos
        const formData = new FormData();
        formData.append("nombre", nombre);
        formData.append("tipo_etiqueta", tipoEtiqueta);
        formData.append("impresora_id", impresoraId);
        formData.append("insumo_id", insumoId);
        formData.append("rotacion_id", rotacionId);
        formData.append(
          "contenido_zpl",
          document.getElementById("etiqueta").value
        );
        formData.append("csrfmiddlewaretoken", csrfToken);

        // Enviar la solicitud para crear la etiqueta
        fetch("{% url 'crear_etiqueta' %}", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            // Siempre intentar obtener el JSON, incluso en caso de error HTTP
            return response.json().then((data) => {
              if (!response.ok) {
                // Si tenemos un JSON con error, usarlo para el mensaje de error
                throw {
                  message: data.error || "Error al crear la etiqueta",
                  errorType: data.errorType,
                  data: data,
                };
              }
              return data;
            });
          })
          .then((data) => {
            if (data.success) {
              // Mostrar toast de éxito
              mostrarToast(`Etiqueta creada correctamente.`, "success", 4000);

              // Limpiar el formulario
              document.getElementById("nombre_etiqueta").value = "";

              // Actualizar la información de configuración para reflejar "Sin nombre"
              actualizarInfoConfigManual();

              // También actualizar la previsualización para mostrar la configuración actualizada
              visualizarEtiquetaCompleta();
            } else {
              mostrarToast(
                "Error al crear la etiqueta: " + data.error,
                "error",
                4000
              );
            }
          })
          .catch((error) => {
            console.error("Error:", error);

            // Verificar si es un error de duplicado
            const errorMsg = error.message || error.toString();
            if (
              error.errorType === "duplicate" ||
              errorMsg.includes("Ya existe una etiqueta con el nombre")
            ) {
              // Mostrar toast de error por duplicado
              mostrarToast(errorMsg, "error", 4000);

              // Resaltar el campo de nombre
              nombreInput.classList.add("is-invalid");
              let feedbackEl = nombreInput.nextElementSibling;
              if (
                !feedbackEl ||
                !feedbackEl.classList.contains("invalid-feedback")
              ) {
                feedbackEl = document.createElement("div");
                feedbackEl.className = "invalid-feedback";
                feedbackEl.textContent =
                  "Ya existe una etiqueta con este nombre para el tipo seleccionado. Por favor use otro nombre.";
                nombreInput.parentNode.insertBefore(
                  feedbackEl,
                  nombreInput.nextSibling
                );
              }
            } else {
              // Error genérico
              mostrarToast(
                "Error al crear la etiqueta: " + error.message,
                "error",
                4000
              );
            }
          });
      }

      // Inicializar cuando la página cargue
      // Función para verificar el estado del entorno
      function verificarEntorno() {
        console.group("Diagnóstico del entorno de etiquetas");

        // Verificar componentes críticos
        const componentes = {
          "Selector de tipo de etiqueta":
            document.getElementById("tipo_etiqueta"),
          "Selector de etiqueta": document.getElementById("etiqueta_id"),
          "Editor ZPL": document.getElementById("zpl_editor"),
          "Contenedor del editor":
            document.getElementById("zplEditorContainer"),
          "Selector de impresora": document.getElementById(
            "impresora_id_existente"
          ),
          "Selector de insumo": document.getElementById("insumo_id_existente"),
          "Selector de rotación": document.getElementById(
            "rotacion_id_existente"
          ),
          "Contenedor de configuración": document.getElementById(
            "configExistenteContainer"
          ),
          "Área de información de config": document.getElementById(
            "config_info_existente"
          ),
          "Contenedor de previsualización": document.getElementById(
            "target_etiqueta_existente"
          ),
          "Token CSRF": document.querySelector("[name=csrfmiddlewaretoken]"),
        };

        let hayErrores = false;

        // Verificar cada componente
        for (const [nombre, elemento] of Object.entries(componentes)) {
          if (!elemento) {
            console.error(`❌ No se encontró: ${nombre}`);
            hayErrores = true;
          } else {
            console.log(`✅ ${nombre} OK`);
          }
        }

        // Verificar URL base
        try {
          const baseUrl = "{% url 'get_zpl' 0 %}";
          if (baseUrl.includes("/0/") || baseUrl.includes("=0")) {
            console.log(`✅ URL base para get_zpl configurada: ${baseUrl}`);
          } else {
            console.warn(
              `⚠️ La URL base no tiene el formato esperado: ${baseUrl}`
            );
            // No lo consideramos como error crítico
          }
        } catch (e) {
          console.error("❌ Error al verificar URL base:", e);
          hayErrores = true;
        }

        // Resultado final
        if (hayErrores) {
          console.error("❌ Se encontraron problemas en el entorno");
        } else {
          console.log("✅ Entorno validado correctamente");
        }

        console.groupEnd();
        return !hayErrores;
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 Inicializando aplicación de etiquetas");

        // Inicializar el filtro
        filtrarEtiquetas();

        // Verificar el entorno antes de configurar eventos
        const entornoOK = verificarEntorno();

        if (entornoOK) {
          console.log("✅ Configurando eventos de la aplicación");

          // Asegurar que el filtro se aplique cuando cambie de pestaña
          const manualTab = document.getElementById("manual-tab");
          if (manualTab) {
            manualTab.addEventListener("shown.bs.tab", function () {
              console.log("🔄 Cambiando a pestaña de edición manual");
              verificarEntorno();
              // Forzar actualización de previsualización
              setTimeout(function () {
                actualizarPrevisualizacionManual();
              }, 100);
            });
          }

          const etiquetasTab = document.getElementById("etiquetas-tab");
          if (etiquetasTab) {
            etiquetasTab.addEventListener("shown.bs.tab", function () {
              console.log("🔄 Cambiando a pestaña de etiquetas existentes");
              filtrarEtiquetas();
              verificarEntorno();
              // Si hay una etiqueta seleccionada, actualizar su previsualización
              const etiquetaIdSelect = document.getElementById("etiqueta_id");
              if (etiquetaIdSelect && etiquetaIdSelect.value) {
                setTimeout(function () {
                  cargarYVisualizarEtiqueta(etiquetaIdSelect.value);
                }, 100);
              }
            });
          }

          // Agregar listeners para actualización en tiempo real en modo manual
          const elementosManual = [
            { id: "etiqueta", evento: "input" },
            { id: "impresora_id", evento: "change" },
            { id: "insumo_id", evento: "change" },
            { id: "rotacion_id", evento: "change" },
            // Quitamos el campo nombre_etiqueta de aquí ya que lo manejaremos por separado
            { id: "tipo_etiqueta_manual", evento: "change" },
          ];

          elementosManual.forEach((item) => {
            const el = document.getElementById(item.id);
            if (el) {
              el.addEventListener(
                item.evento,
                actualizarPrevisualizacionManual
              );
              console.log(`✅ Listener agregado para ${item.id}`);
            } else {
              console.warn(`⚠️ No se pudo agregar listener para ${item.id}`);
            }
          });

          // Agregar evento especial para el campo de nombre con debounce más largo
          const nombreEtiquetaEl = document.getElementById("nombre_etiqueta");
          if (nombreEtiquetaEl) {
            nombreEtiquetaEl.addEventListener("input", function () {
              // Limpiar el timeout anterior si existe
              if (timeoutNombre) clearTimeout(timeoutNombre);

              // Establecer un nuevo timeout con 300ms de espera
              timeoutNombre = setTimeout(() => {
                console.log(
                  "🔄 Actualizando previsualización después de cambio en nombre"
                );
                actualizarPrevisualizacionManual();
              }, 800); // 800ms de debounce para dar más tiempo para escribir
            });
            console.log(
              `✅ Listener con debounce especial agregado para nombre_etiqueta`
            );
          } else {
            console.warn(`⚠️ No se pudo agregar listener para nombre_etiqueta`);
          }

          // Configurar el selector de etiquetas
          const etiquetaIdSelect = document.getElementById("etiqueta_id");
          if (etiquetaIdSelect) {
            etiquetaIdSelect.addEventListener("change", function () {
              const etiquetaId = this.value;
              console.log(`🔄 Seleccionada etiqueta con ID: ${etiquetaId}`);
              if (etiquetaId) {
                // Mostrar spinner de carga
                const spinnerHTML = `
                  <div id="spinner-carga-etiqueta" class="text-center my-3 py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando etiqueta...</span>
                    </div>
                    <div class="mt-3 fw-bold">Cargando etiqueta...</div>
                  </div>
                `;
                document.getElementById("target_etiqueta_existente").innerHTML =
                  `<div class="alert alert-info mb-3" id="config_info_existente">Cargando etiqueta...</div>` +
                  spinnerHTML;

                // Cargar y visualizar la etiqueta seleccionada
                // La función cargarYVisualizarEtiqueta se encargará de actualizar la UI
                // y mostrar el campo de nombre con el valor correcto
                cargarYVisualizarEtiqueta(etiquetaId);
              } else {
                // Limpiar la vista si no hay etiqueta seleccionada
                actualizarUIEtiquetaCargada(false);
                etiquetaActualId = null;
                document.getElementById("zpl_editor").value = "";

                // Ya no necesitamos esto porque eliminamos el contenedor
                // document.getElementById("nombre_nueva_etiqueta").value = "";

                etiquetaActualId = null;
                document.getElementById("config_info_existente").innerHTML =
                  "Seleccione una etiqueta para previsualizar";
                document.getElementById("target_etiqueta_existente").innerHTML =
                  '<div class="alert alert-info mb-3" id="config_info_existente">Seleccione una etiqueta para previsualizar</div>';
              }
            });
            console.log("✅ Listener agregado para etiqueta_id");
          } else {
            console.warn("⚠️ No se pudo agregar listener para etiqueta_id");
          }

          // Agregar listeners para actualización en tiempo real en modo etiquetas existentes
          const zplEditor = document.getElementById("zpl_editor");
          if (zplEditor) {
            zplEditor.addEventListener(
              "input",
              actualizarPrevisualizacionExistente
            );
            console.log("✅ Listener agregado para zpl_editor");
          }

          // Agregar listeners a selectores de configuración existente
          const elementosExistentes = [
            "impresora_id_existente",
            "insumo_id_existente",
            "rotacion_id_existente",
            "idioma_existente",
            // Quitamos el campo nombre_etiqueta_actual para manejarlo por separado
          ];

          elementosExistentes.forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              el.addEventListener("change", () => {
                console.log(
                  `🔄 Cambio en ${id}, generando etiqueta (etiquetaActualId: ${etiquetaActualId})`
                );

                // Verificar que tengamos un ID de etiqueta válido
                if (!etiquetaActualId) {
                  console.warn(
                    `⚠️ No hay etiqueta actual seleccionada al cambiar ${id}`
                  );
                  document.getElementById(
                    "config_info_existente"
                  ).innerHTML = `<div class="alert alert-warning">Por favor, seleccione primero una etiqueta</div>`;
                  return;
                }

                generarEtiqueta(true);
              });
              console.log(`✅ Listener agregado para ${id} con evento change`);
            } else {
              console.warn(`⚠️ No se pudo agregar listener para ${id}`);
            }
          });

          // Manejar el campo de nombre por separado con un debounce más largo
          const nombreEtiquetaActualEl = document.getElementById(
            "nombre_etiqueta_actual"
          );
          if (nombreEtiquetaActualEl) {
            nombreEtiquetaActualEl.addEventListener("input", function () {
              // Limpiar el timeout anterior si existe
              if (timeoutNombre) clearTimeout(timeoutNombre);

              // Actualizar inmediatamente solo la parte visual del nombre
              actualizarInfoEtiqueta();

              // Establecer un nuevo timeout con 800ms de espera para la generación de etiqueta
              timeoutNombre = setTimeout(() => {
                console.log(
                  "🔄 Generando etiqueta después de cambio en nombre"
                );
                generarEtiqueta(true);
              }, 800); // 800ms de debounce para dar más tiempo para escribir
            });
            console.log(
              `✅ Listener con debounce especial agregado para nombre_etiqueta_actual`
            );
          } else {
            console.warn(
              `⚠️ No se pudo agregar listener para nombre_etiqueta_actual`
            );
          }

          // Cargar la previsualización inicial para el modo manual inmediatamente
          console.log("Cargando previsualización inicial para modo manual");
          // Usamos setTimeout para asegurarnos de que todo esté cargado completamente
          setTimeout(function () {
            actualizarPrevisualizacionManual();
          }, 100);
        } else {
          console.error(
            "❌ No se pudieron configurar todos los eventos debido a errores en el entorno"
          );
        }

        // Inicializar el tema
        initTheme();
      });

      // Función para cambiar entre tema claro y oscuro
      function toggleTheme() {
        const html = document.documentElement;
        const themeIcon = document.getElementById("theme-icon");

        if (html.getAttribute("data-bs-theme") === "dark") {
          html.setAttribute("data-bs-theme", "light");
          themeIcon.classList.remove("bi-moon-fill");
          themeIcon.classList.add("bi-sun-fill");
          localStorage.setItem("theme", "light");
        } else {
          html.setAttribute("data-bs-theme", "dark");
          themeIcon.classList.remove("bi-sun-fill");
          themeIcon.classList.add("bi-moon-fill");
          localStorage.setItem("theme", "dark");
        }
      }

      // Función para inicializar el tema según el localStorage
      function initTheme() {
        const savedTheme = localStorage.getItem("theme");
        const themeIcon = document.getElementById("theme-icon");

        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-bs-theme", "dark");
          themeIcon.classList.remove("bi-sun-fill");
          themeIcon.classList.add("bi-moon-fill");
        } else {
          document.documentElement.setAttribute("data-bs-theme", "light");
          themeIcon.classList.remove("bi-moon-fill");
          themeIcon.classList.add("bi-sun-fill");
        }

        // Agregar evento click al botón de cambio de tema
        document
          .getElementById("theme-toggle")
          .addEventListener("click", toggleTheme);
      }

      // Función para obtener el token CSRF
      function getCsrfToken() {
        const csrfTokenElement = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        );
        if (!csrfTokenElement) {
          console.error("Token CSRF no encontrado en el DOM");
          return "";
        }
        return csrfTokenElement.value;
      }

      // Función para actualizar la previsualización en tiempo real en modo edición manual
      function actualizarPrevisualizacionManual() {
        console.log("Iniciando actualización de previsualización manual");
        try {
          // Limpiar el timeout anterior para evitar múltiples solicitudes
          if (timeoutManual) clearTimeout(timeoutManual);

          // Establecer un nuevo timeout para debounce (300ms)
          timeoutManual = setTimeout(function () {
            console.log("Ejecutando actualización de previsualización manual");

            // Obtener los valores actuales
            const impresoraEl = document.getElementById("impresora_id");
            const insumoEl = document.getElementById("insumo_id");
            const rotacionEl = document.getElementById("rotacion_id");
            const zplEl = document.getElementById("etiqueta");
            const nombreEtiquetaEl = document.getElementById("nombre_etiqueta");
            const tipoEtiquetaEl = document.getElementById(
              "tipo_etiqueta_manual"
            );
            const configInfoEl = document.getElementById("config_info_manual");
            const targetEl = document.getElementById("target_etiqueta");

            // Verificar el nombre sin impedir la previsualización
            if (nombreEtiquetaEl && !nombreEtiquetaEl.value.trim()) {
              nombreEtiquetaEl.classList.add("is-invalid");
            } else if (nombreEtiquetaEl) {
              nombreEtiquetaEl.classList.remove("is-invalid");
            }

            // Verificar que los elementos existan
            if (
              !impresoraEl ||
              !insumoEl ||
              !rotacionEl ||
              !zplEl ||
              !tipoEtiquetaEl ||
              !configInfoEl ||
              !targetEl
            ) {
              console.error(
                "Faltan elementos necesarios para la previsualización",
                {
                  impresora: !!impresoraEl,
                  insumo: !!insumoEl,
                  rotacion: !!rotacionEl,
                  zpl: !!zplEl,
                  tipo: !!tipoEtiquetaEl,
                  configInfo: !!configInfoEl,
                  target: !!targetEl,
                }
              );
              return;
            }

            const impresoraId = impresoraEl.value;
            const insumoId = insumoEl.value;
            const rotacionId = rotacionEl.value;
            const zpl = zplEl.value;
            const nombreEtiqueta = nombreEtiquetaEl
              ? nombreEtiquetaEl.value
              : "";
            const tipoEtiqueta = tipoEtiquetaEl.value;

            // Verificar que tengamos todos los datos necesarios, pero permitir continuar con valores por defecto
            let faltanDatos = false;
            let mensajeError = "";

            if (!zpl || zpl.trim() === "") {
              console.warn("ZPL vacío en actualizarPrevisualizacionManual");
              configInfoEl.innerHTML =
                "Ingrese código ZPL para previsualizar la etiqueta";
              return;
            }

            // Verificamos cada elemento requerido
            if (!impresoraId) {
              faltanDatos = true;
              mensajeError += "Debe seleccionar una impresora. ";
            }

            if (!insumoId) {
              faltanDatos = true;
              mensajeError += "Debe seleccionar un insumo. ";
            }

            if (!rotacionId) {
              faltanDatos = true;
              mensajeError += "Debe seleccionar una rotación. ";
            }

            // Si los datos están incompletos pero tenemos ZPL, continuamos con la previsualización
            // pero mostramos una advertencia
            if (faltanDatos) {
              console.warn(
                "Datos incompletos para la previsualización:",
                mensajeError
              );
              configInfoEl.innerHTML = `<div class="alert alert-warning">${mensajeError} Se usarán valores predeterminados.</div>`;
            }

            // Actualizar la información de configuración
            actualizarInfoConfigManual();

            // Mostrar spinner de carga mientras se genera la previsualización
            const spinnerHTML = `
              <div id="spinner-manual" class="text-center my-3 py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Generando previsualización...</span>
                </div>
                <div class="mt-3 fw-bold">Generando previsualización...</div>
              </div>
            `;
            targetEl.innerHTML = configInfoEl.outerHTML + spinnerHTML;

            console.log("Generando previsualización para:", {
              nombre: nombreEtiqueta || "Sin nombre",
              tipo: tipoEtiqueta,
              impresora: impresoraId,
              insumo: insumoId,
              rotacion: rotacionId,
            });

            // Crear FormData y enviar la solicitud
            const formData = new FormData();
            const csrfToken = getCsrfToken();

            if (!csrfToken) {
              console.error("No se pudo obtener el token CSRF");
              configInfoEl.innerHTML = `<div class="alert alert-danger">Error: No se pudo obtener el token CSRF</div>`;
              return;
            }

            formData.append("impresora_id", impresoraId);
            formData.append("insumo_id", insumoId);
            formData.append("rotacion_id", rotacionId);
            formData.append("tipo_etiqueta", tipoEtiqueta);
            formData.append("zpl", zpl);
            formData.append("csrfmiddlewaretoken", csrfToken);
            formData.append("preview", "true");

            // Incluir el idioma seleccionado
            const idiomaSelect = document.getElementById("idioma");
            if (idiomaSelect) {
              formData.append("idioma", idiomaSelect.value);
              console.log(
                "Idioma seleccionado para previsualización manual:",
                idiomaSelect.value
              );
            }

            // Enviar la solicitud para visualizar la etiqueta
            fetch("{% url 'visualizar_etiqueta' %}", {
              method: "POST",
              body: formData,
              headers: {
                "X-Requested-With": "XMLHttpRequest", // Indicar que es una solicitud AJAX
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(
                    `Error HTTP: ${response.status} - ${response.statusText}`
                  );
                }
                return response.text();
              })
              .then((html) => {
                // Conservar el div de configuración y agregar la imagen
                const configInfo = configInfoEl.outerHTML;
                targetEl.innerHTML = configInfo + html;
                console.log(
                  "Previsualización manual actualizada correctamente"
                );
              })
              .catch((error) => {
                console.error(
                  "Error en actualizarPrevisualizacionManual:",
                  error
                );
                configInfoEl.innerHTML = `<div class="alert alert-danger">Error al generar la previsualización: ${error.message}</div>`;
              });
          }, 300); // 300ms de debounce
        } catch (err) {
          console.error(
            "Error general en actualizarPrevisualizacionManual:",
            err
          );
          const configInfoEl = document.getElementById("config_info_manual");
          if (configInfoEl) {
            configInfoEl.innerHTML = `<div class="alert alert-danger">Error inesperado: ${err.message}</div>`;
          }
        }
      }

      // Función para actualizar la información de configuración en modo manual
      function actualizarInfoConfigManual() {
        const impresoraEl = document.getElementById("impresora_id");
        const insumoEl = document.getElementById("insumo_id");
        const rotacionEl = document.getElementById("rotacion_id");
        const tipoEl = document.getElementById("tipo_etiqueta_manual");
        const nombreEl = document.getElementById("nombre_etiqueta");
        const idiomaEl = document.getElementById("idioma");

        const impresoraText =
          impresoraEl.options[impresoraEl.selectedIndex].text;
        const insumoText = insumoEl.options[insumoEl.selectedIndex].text;
        const rotacionText = rotacionEl.options[rotacionEl.selectedIndex].text;
        const tipoText = tipoEl.options[tipoEl.selectedIndex].text;
        const nombreText = nombreEl.value || "Sin nombre";
        const idiomaText = idiomaEl.options[idiomaEl.selectedIndex].text;

        configActualManual = {
          impresora: impresoraEl.value,
          insumo: insumoEl.value,
          rotacion: rotacionEl.value,
          tipo: tipoEl.value,
          idioma: idiomaEl.value,
        };

        document.getElementById("config_info_manual").innerHTML =
          `<strong>Nombre:</strong> ${nombreText} | <strong>Tipo:</strong> ${tipoText}<br>` +
          `<strong>Impresora:</strong> ${impresoraText} | <strong>Tamaño:</strong> ${insumoText} | <strong>Rotación:</strong> ${rotacionText} | <strong>Idioma:</strong> ${idiomaText}`;
      }

      // Función para actualizar la previsualización en tiempo real en modo etiquetas existentes
      function actualizarPrevisualizacionExistente() {
        try {
          // Limpiar el timeout anterior para evitar múltiples solicitudes
          if (timeoutExistente) clearTimeout(timeoutExistente);

          // Establecer un nuevo timeout para debounce (300ms)
          timeoutExistente = setTimeout(function () {
            if (!etiquetaActualId) {
              console.warn("No hay etiqueta seleccionada");
              document.getElementById("config_info_existente").innerHTML =
                "Seleccione una etiqueta para previsualizar";
              return;
            }

            // Verificar el nombre sin impedir la previsualización
            const nombreEtiquetaEl = document.getElementById(
              "nombre_etiqueta_actual"
            );
            if (nombreEtiquetaEl && !nombreEtiquetaEl.value.trim()) {
              nombreEtiquetaEl.classList.add("is-invalid");
            } else if (nombreEtiquetaEl) {
              nombreEtiquetaEl.classList.remove("is-invalid");
            }

            const zplEditor = document.getElementById("zpl_editor");
            if (!zplEditor) {
              console.error("Editor ZPL no encontrado");
              return;
            }

            const zpl = zplEditor.value;
            if (!zpl || zpl.trim() === "") {
              console.warn("ZPL vacío, no se actualiza la previsualización");
              return;
            }

            console.log(
              "Actualizando previsualización existente para etiqueta ID:",
              etiquetaActualId
            );

            // Actualizar la información de configuración
            generarEtiqueta(true);
          }, 300); // 300ms de debounce
        } catch (err) {
          console.error(
            "Error general en actualizarPrevisualizacionExistente:",
            err
          );
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error al actualizar previsualización: ${err.message}</div>`;
        }
      }

      // Función para actualizar la información de configuración en modo etiquetas existentes
      function actualizarInfoConfigExistente(etiquetaData) {
        try {
          console.log(
            "Actualizando información de configuración con datos:",
            etiquetaData
          );

          const configInfoEl = document.getElementById("config_info_existente");
          if (!configInfoEl) {
            console.error("Elemento config_info_existente no encontrado");
            return;
          }

          // Obtener selectores de configuración
          const impresoraEl = document.getElementById("impresora_id_existente");
          const insumoEl = document.getElementById("insumo_id_existente");
          const rotacionEl = document.getElementById("rotacion_id_existente");

          // Verificar si tenemos datos completos proporcionados
          if (
            etiquetaData &&
            etiquetaData.impresora &&
            etiquetaData.insumo &&
            etiquetaData.rotacion
          ) {
            // Datos completos proporcionados
            try {
              // Obtener el nombre y tipo de la etiqueta seleccionada
              const etiquetaSelect = document.getElementById("etiqueta_id");
              if (!etiquetaSelect) {
                console.error("Elemento etiqueta_id no encontrado");
                configInfoEl.innerHTML =
                  "Error: Selector de etiquetas no encontrado";
                return;
              }

              if (etiquetaSelect.selectedIndex <= 0) {
                console.warn("No hay etiqueta seleccionada");
                configInfoEl.innerHTML =
                  "Seleccione una etiqueta para ver la configuración";
                return;
              }

              const etiquetaOption =
                etiquetaSelect.options[etiquetaSelect.selectedIndex];
              if (!etiquetaOption) {
                console.warn("Opción de etiqueta no encontrada");
                configInfoEl.innerHTML =
                  "Error al obtener datos de la etiqueta seleccionada";
                return;
              }

              // Obtener el nombre actual del input si está disponible
              let nombreEtiqueta;
              const nombreInput = document.getElementById(
                "nombre_etiqueta_actual"
              );
              if (nombreInput && nombreInput.value.trim()) {
                // Usar el valor editado por el usuario si existe
                nombreEtiqueta = nombreInput.value.trim();
                console.log(
                  "Usando nombre editado por el usuario:",
                  nombreEtiqueta
                );
              } else {
                // Si no hay valor editado, usar el original de la etiqueta
                nombreEtiqueta = etiquetaOption.textContent
                  .split("(")[0]
                  .trim();
                console.log(
                  "Usando nombre original de la etiqueta:",
                  nombreEtiqueta
                );
              }

              const tipoEtiqueta =
                etiquetaOption.getAttribute("data-tipo") || "No especificado";

              // Obtener el idioma seleccionado
              const idiomaEl = document.getElementById("idioma_existente");
              const idiomaText = idiomaEl
                ? idiomaEl.options[idiomaEl.selectedIndex].text
                : "Español";

              configInfoEl.innerHTML =
                `<strong>Nombre:</strong> ${nombreEtiqueta} | <strong>Tipo:</strong> ${tipoEtiqueta}<br>` +
                `<strong>Impresora:</strong> ${etiquetaData.impresora} | <strong>Tamaño:</strong> ${etiquetaData.insumo} | <strong>Rotación:</strong> ${etiquetaData.rotacion} | <strong>Idioma:</strong> ${idiomaText}`;

              console.log(
                "Configuración actualizada con datos proporcionados:",
                {
                  nombre: nombreEtiqueta,
                  tipo: tipoEtiqueta,
                  impresora: etiquetaData.impresora,
                  insumo: etiquetaData.insumo,
                  rotacion: etiquetaData.rotacion,
                }
              );
            } catch (innerErr) {
              console.error("Error al procesar datos de etiqueta:", innerErr);
              configInfoEl.innerHTML = `<div class="alert alert-warning">Error al procesar información de la etiqueta: ${innerErr.message}</div>`;
            }
          } else {
            console.warn(
              "Datos de etiqueta incompletos, intentando construir con selectores"
            );

            // Intentar construir datos a partir de los selectores actuales
            if (
              impresoraEl &&
              insumoEl &&
              rotacionEl &&
              impresoraEl.selectedIndex >= 0 &&
              insumoEl.selectedIndex >= 0 &&
              rotacionEl.selectedIndex >= 0
            ) {
              try {
                // Obtener datos de los selectores actuales
                const impresoraText =
                  impresoraEl.options[impresoraEl.selectedIndex].text;
                const insumoText =
                  insumoEl.options[insumoEl.selectedIndex].text;
                const rotacionText =
                  rotacionEl.options[rotacionEl.selectedIndex].text;

                // Intentar obtener información básica de la etiqueta seleccionada
                const etiquetaSelect = document.getElementById("etiqueta_id");
                if (etiquetaSelect && etiquetaSelect.selectedIndex > 0) {
                  const etiquetaOption =
                    etiquetaSelect.options[etiquetaSelect.selectedIndex];
                  // Obtener el nombre actual del input si está disponible
                  let nombreEtiqueta;
                  const nombreInput = document.getElementById(
                    "nombre_etiqueta_actual"
                  );
                  if (nombreInput && nombreInput.value.trim()) {
                    // Usar el valor editado por el usuario si existe
                    nombreEtiqueta = nombreInput.value.trim();
                    console.log(
                      "Usando nombre editado por el usuario (desde selectores):",
                      nombreEtiqueta
                    );
                  } else {
                    // Si no hay valor editado, usar el original de la etiqueta
                    nombreEtiqueta = etiquetaOption.textContent
                      .split("(")[0]
                      .trim();
                    console.log(
                      "Usando nombre original de la etiqueta (desde selectores):",
                      nombreEtiqueta
                    );
                  }

                  const tipoEtiqueta =
                    etiquetaOption.getAttribute("data-tipo") ||
                    "No especificado";

                  // Obtener el idioma seleccionado
                  const idiomaEl = document.getElementById("idioma_existente");
                  const idiomaText = idiomaEl
                    ? idiomaEl.options[idiomaEl.selectedIndex].text
                    : "Español";

                  // Actualizar la configuración visual
                  configInfoEl.innerHTML =
                    `<strong>Nombre:</strong> ${nombreEtiqueta} | <strong>Tipo:</strong> ${tipoEtiqueta}<br>` +
                    `<strong>Impresora:</strong> ${impresoraText} | <strong>Tamaño:</strong> ${insumoText} | <strong>Rotación:</strong> ${rotacionText} | <strong>Idioma:</strong> ${idiomaText}`;

                  console.log("Configuración actualizada desde selectores:", {
                    nombre: nombreEtiqueta,
                    tipo: tipoEtiqueta,
                    impresora: impresoraText,
                    insumo: insumoText,
                    rotacion: rotacionText,
                    idioma: idiomaText,
                  });
                } else {
                  // Obtener el idioma seleccionado
                  const idiomaEl = document.getElementById("idioma_existente");
                  const idiomaText = idiomaEl
                    ? idiomaEl.options[idiomaEl.selectedIndex].text
                    : "Español";

                  configInfoEl.innerHTML =
                    `<strong>Impresora:</strong> ${impresoraText} | <strong>Tamaño:</strong> ${insumoText} | <strong>Rotación:</strong> ${rotacionText} | <strong>Idioma:</strong> ${idiomaText}<br>` +
                    `<div class="alert alert-warning">Información de etiqueta no disponible</div>`;
                }
              } catch (selectErr) {
                console.error(
                  "Error al obtener datos de los selectores:",
                  selectErr
                );
                configInfoEl.innerHTML = `<div class="alert alert-warning">Error al procesar selectores: ${selectErr.message}</div>`;
              }
            } else {
              console.warn("No se pudieron obtener valores de los selectores");
              configInfoEl.innerHTML = `<div class="alert alert-warning">Información de configuración no disponible</div>`;
            }
          }
        } catch (err) {
          console.error("Error en actualizarInfoConfigExistente:", err);
          const configInfoEl = document.getElementById("config_info_existente");
          if (configInfoEl) {
            configInfoEl.innerHTML = `<div class="alert alert-danger">Error al procesar la configuración: ${err.message}</div>`;
          }
        }
      }

      // Función para cargar y visualizar automáticamente una etiqueta existente
      function cargarYVisualizarEtiqueta(etiquetaId) {
        try {
          if (!etiquetaId) {
            console.log("No se proporcionó ID de etiqueta");
            return;
          }

          console.log("Cargando y visualizando etiqueta con ID:", etiquetaId);

          // Mostrar y cargar el nombre de la etiqueta seleccionada
          const etiquetaOption = document.querySelector(
            `#etiqueta_id option[value="${etiquetaId}"]`
          );
          if (etiquetaOption) {
            // Asegurar que el UI se actualice para mostrar los campos necesarios
            actualizarUIEtiquetaCargada(true);

            // Cargar el nombre en el campo
            const nombreEtiquetaInput = document.getElementById(
              "nombre_etiqueta_actual"
            );
            if (nombreEtiquetaInput) {
              // Extraer solo el nombre, eliminando el identificador entre paréntesis si existe
              const nombreLimpio = etiquetaOption.textContent
                .split("(")[0]
                .trim();
              nombreEtiquetaInput.value = nombreLimpio;
              console.log(
                "Nombre de etiqueta cargado (limpio):",
                nombreLimpio,
                "| Original:",
                etiquetaOption.textContent.trim()
              );
            } else {
              console.error("No se encontró el campo de nombre de etiqueta");
            }
          }

          // Guardar el ID de la etiqueta seleccionada
          etiquetaActualId = etiquetaId;

          // Construir la URL con URL reversa
          let baseUrl = "{% url 'get_zpl' 0 %}";
          // Verificamos diferentes patrones posibles para reemplazar el ID
          let url;
          if (baseUrl.includes("/0/")) {
            // Patrón: /etiquetas/get_zpl/0/
            url = baseUrl.replace("/0/", `/${etiquetaId}/`);
          } else if (baseUrl.includes("=0")) {
            // Patrón: /etiquetas/get_zpl?id=0
            url = baseUrl.replace("=0", `=${etiquetaId}`);
          } else {
            // Construir la URL manualmente como último recurso
            url = `/etiquetas/get_zpl/${etiquetaId}/`;
          }
          console.log("URL construida:", url);

          // Mostrar spinner mientras se carga la etiqueta
          const spinnerHTML = `
            <div id="spinner-carga-zpl" class="text-center my-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando datos de etiqueta...</span>
              </div>
              <div class="mt-2">Cargando datos de etiqueta...</div>
            </div>
          `;
          // Ya se debería haber mostrado un spinner en la parte anterior del código

          // Configuración de la solicitud
          const csrfToken = getCsrfToken();
          const requestOptions = {
            method: "GET",
            headers: {
              Accept: "application/json",
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": csrfToken, // Añadimos el token CSRF por si acaso
            },
            cache: "no-store", // Evitar caché
          };

          // Solicitar el contenido ZPL y su configuración
          fetch(url, requestOptions)
            .then((response) => {
              console.log(
                "Respuesta recibida:",
                response.status,
                response.statusText
              );
              if (!response.ok) {
                // Intentar leer cualquier mensaje de error que el servidor haya devuelto
                return response
                  .json()
                  .then((data) => {
                    throw new Error(
                      data.error ||
                        `Error HTTP: ${response.status} - ${response.statusText}`
                    );
                  })
                  .catch((err) => {
                    // Si no se puede parsear como JSON, lanzar el error HTTP original
                    if (err.name === "SyntaxError") {
                      throw new Error(
                        `Error HTTP: ${response.status} - ${response.statusText}`
                      );
                    }
                    throw err; // Re-lanzar el error si ya es un error de nuestro código
                  });
              }
              return response.json().catch((err) => {
                console.error("Error al parsear JSON:", err);
                throw new Error("El servidor no devolvió un JSON válido");
              });
            })
            .then((data) => {
              console.log("ZPL cargado correctamente:", data);

              if (!data || (typeof data.zpl === "undefined" && !data.error)) {
                throw new Error(
                  "La respuesta no contiene datos ZPL ni un mensaje de error"
                );
              }

              if (data.error) {
                throw new Error(`Error del servidor: ${data.error}`);
              }

              // Mostrar el editor ZPL y el botón de guardar
              document.getElementById("zplEditorContainer").style.display =
                "block";
              document.getElementById("btnGuardarZPL").style.display =
                "inline-block";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "flex";

              // Cargar el ZPL en el editor
              const zplEditor = document.getElementById("zpl_editor");
              if (!zplEditor) {
                throw new Error("No se encontró el elemento zpl_editor");
              }
              zplEditor.value = data.zpl || "";

              if (!data.zpl || data.zpl.trim() === "") {
                console.warn("El ZPL recibido está vacío");
                document.getElementById(
                  "config_info_existente"
                ).innerHTML = `<div class="alert alert-warning">La etiqueta no contiene código ZPL</div>`;
                return;
              }

              // Actualizar la información de configuración
              if (data.config) {
                console.log("Config recibida:", data.config);

                // Verificar que todos los selectores existen
                const impresoraEl = document.getElementById(
                  "impresora_id_existente"
                );
                const insumoEl = document.getElementById("insumo_id_existente");
                const rotacionEl = document.getElementById(
                  "rotacion_id_existente"
                );

                if (!impresoraEl || !insumoEl || !rotacionEl) {
                  console.error(
                    "No se encontraron todos los selectores de configuración"
                  );
                  throw new Error(
                    "No se encontraron los selectores de configuración necesarios"
                  );
                }

                // Establecer los valores de los selectores
                impresoraEl.value = data.config.impresora_id;
                insumoEl.value = data.config.insumo_id;
                rotacionEl.value = data.config.rotacion_id;

                actualizarInfoConfigExistente(data.config);
                configActualExistente = {
                  impresora: data.config.impresora_id,
                  insumo: data.config.insumo_id,
                  rotacion: data.config.rotacion_id,
                };

                // Generar previsualización inmediatamente
                generarPreviewInmediato(data.zpl, data.config);
              } else {
                console.warn(
                  "No se recibieron datos de configuración completos"
                );
                document.getElementById(
                  "config_info_existente"
                ).innerHTML += `<div class="alert alert-warning">No se recibió la configuración completa de la etiqueta</div>`;
              }
            })
            .catch((error) => {
              console.error("Error al cargar ZPL:", error);
              document.getElementById("zplEditorContainer").style.display =
                "none";
              document.getElementById("btnGuardarZPL").style.display = "none";
              document.getElementById(
                "configExistenteContainer"
              ).style.display = "none";
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al cargar el ZPL: ${error.message}</div>`;
            });
        } catch (err) {
          console.error("Error en cargarYVisualizarEtiqueta:", err);
          document.getElementById(
            "config_info_existente"
          ).innerHTML = `<div class="alert alert-danger">Error general: ${err.message}</div>`;
        }
      }

      // Función para generar una vista previa inmediata de la etiqueta
      function generarPreviewInmediato(zpl, config) {
        try {
          if (!zpl || !config) {
            console.error("Faltan datos para generar la previsualización");
            return;
          }

          console.log("Generando previsualización inmediata");

          const csrfToken = getCsrfToken();
          if (!csrfToken) {
            console.error("No se pudo obtener el token CSRF");
            return;
          }

          // Crear un formulario temporal para enviar los datos
          const formData = new FormData();
          formData.append("etiqueta_id", etiquetaActualId);
          formData.append("csrfmiddlewaretoken", csrfToken);
          formData.append("zpl_custom", zpl);
          formData.append("impresora_id", config.impresora_id);
          formData.append("insumo_id", config.insumo_id);
          formData.append("rotacion_id", config.rotacion_id);
          formData.append("idioma", config.idioma || "es"); // Usar idioma por defecto si no se proporciona

          // Incluir el idioma seleccionado
          const idiomaSelect = document.getElementById("idioma_existente");
          if (idiomaSelect) {
            formData.append("idioma", idiomaSelect.value);
            console.log(
              "Idioma seleccionado para preview:",
              idiomaSelect.value
            );
          } else {
            console.warn(
              "No se encontró el selector de idioma para etiquetas existentes"
            );
          }

          // URL para la solicitud
          const url = "{% url 'etiqueta_png' %}";

          // Mostrar spinner de carga mientras se genera la etiqueta
          const spinnerHTML = `
            <div id="spinner-preview-inmediato" class="text-center my-3 py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando previsualización...</span>
              </div>
              <div class="mt-3 fw-bold">Generando previsualización...</div>
            </div>
          `;
          document.getElementById("target_etiqueta_existente").innerHTML =
            document.getElementById("config_info_existente").outerHTML +
            spinnerHTML;

          // Enviar la solicitud para generar la etiqueta
          fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `Error HTTP: ${response.status} - ${response.statusText}`
                );
              }
              return response.text();
            })
            .then((html) => {
              // Obtener el nombre actual antes de reemplazar el contenido
              const nombreActual =
                document
                  .getElementById("nombre_etiqueta_actual")
                  .value.trim() || "Sin nombre";

              // Conservar el div de configuración y agregar la imagen
              const configInfo = document.getElementById(
                "config_info_existente"
              ).outerHTML;
              document.getElementById("target_etiqueta_existente").innerHTML =
                configInfo + html;

              // Asegurarse de que el nombre mostrado sea el actualizado
              actualizarInfoEtiqueta();
              console.log(
                "Previsualización inmediata completada con nombre:",
                nombreActual
              );
            })
            .catch((error) => {
              console.error("Error en previsualización inmediata:", error);
              document.getElementById(
                "config_info_existente"
              ).innerHTML = `<div class="alert alert-danger">Error al generar la previsualización: ${error.message}</div>`;
            });
        } catch (err) {
          console.error("Error general en generarPreviewInmediato:", err);
        }
      }

      // Función para crear una nueva etiqueta a partir de una etiqueta existente

      // Función auxiliar para obtener el token CSRF
      function getCsrfToken() {
        return document.querySelector("[name=csrfmiddlewaretoken]").value;
      }

      // Función para actualizar la información de la etiqueta cuando se cambia el nombre
      function actualizarInfoEtiqueta() {
        try {
          // Verificar si hay una etiqueta seleccionada
          if (!etiquetaActualId) {
            console.warn("No hay etiqueta seleccionada para actualizar info");
            return;
          }

          // Obtener el elemento de información de configuración
          const configInfoEl = document.getElementById("config_info_existente");
          if (!configInfoEl) {
            console.error("Elemento config_info_existente no encontrado");
            return;
          }

          // Obtener el nombre actualizado
          const nombreEtiquetaInput = document.getElementById(
            "nombre_etiqueta_actual"
          );
          if (!nombreEtiquetaInput) {
            console.error("No se encontró el campo de nombre de etiqueta");
            return;
          }

          // Obtener la información actual mostrada
          const infoActual = configInfoEl.innerHTML;

          // Actualizar solo la parte del nombre en la información mostrada
          if (infoActual.includes("<strong>Nombre:</strong>")) {
            // Usar un debounce visual más corto para actualizar inmediatamente
            // la visualización del nombre sin esperar a generar la etiqueta
            const nombreActual =
              nombreEtiquetaInput.value.trim() || "Sin nombre";

            // Reemplazar el nombre en la información mostrada usando expresiones regulares
            const nuevoInfo = infoActual.replace(
              /<strong>Nombre:<\/strong>[^|]+/,
              `<strong>Nombre:</strong> ${nombreActual} `
            );

            configInfoEl.innerHTML = nuevoInfo;
            console.log(
              "Información visual de etiqueta actualizada con el nombre:",
              nombreActual
            );

            // También actualizamos la referencia en el select si existe
            try {
              const etiquetaSelect = document.getElementById("etiqueta_id");
              if (
                etiquetaSelect &&
                etiquetaSelect.selectedIndex > 0 &&
                etiquetaActualId
              ) {
                // Solo para depuración, no afecta la funcionalidad
                console.log(
                  "Nombre actualizado en input:",
                  nombreActual,
                  "| Original en select:",
                  etiquetaSelect.options[etiquetaSelect.selectedIndex]
                    .textContent
                );
              }
            } catch (selectErr) {
              console.warn(
                "No se pudo actualizar referencia en select:",
                selectErr
              );
            }
          }
        } catch (err) {
          console.error("Error al actualizar información de etiqueta:", err);
        }
      }

      // Función para mostrar mensajes tipo toast
      function mostrarToast(mensaje, tipo = "success", duracion = 4000) {
        // Crear un ID único para el toast
        const toastId = `toast-${Date.now()}`;

        // Determinar los colores según el tipo
        let bgColor, iconClass, borderClass;
        switch (tipo) {
          case "success":
            bgColor = "bg-success text-white";
            iconClass = "bi-check-circle-fill";
            borderClass = "border-success";
            break;
          case "error":
          case "danger":
            bgColor = "bg-danger text-white";
            iconClass = "bi-exclamation-triangle-fill";
            borderClass = "border-danger";
            break;
          case "warning":
            bgColor = "bg-warning text-dark";
            iconClass = "bi-exclamation-circle-fill";
            borderClass = "border-warning";
            break;
          case "info":
            bgColor = "bg-info text-dark";
            iconClass = "bi-info-circle-fill";
            borderClass = "border-info";
            break;
          default:
            bgColor = "bg-secondary text-white";
            iconClass = "bi-bell-fill";
            borderClass = "border-secondary";
        }

        // Crear el HTML del toast con diseño mejorado y animaciones
        const toastHTML = `
          <div id="${toastId}" class="toast ${bgColor} border-3 ${borderClass} shadow-lg rounded-3" 
               role="alert" aria-live="assertive" aria-atomic="true" 
               style="transition: all 0.3s ease-in-out; opacity: 0; transform: translateY(-20px);">
            <div class="d-flex align-items-center p-3">
              <i class="bi ${iconClass} fs-4 me-2"></i>
              <div class="ms-1">
                <strong>${tipo === "success" ? "Éxito" : "Atención"}</strong>
                <div>${mensaje}</div>
              </div>
            </div>
          </div>
        `;

        // Añadir el toast al contenedor
        document
          .getElementById("toastContainer")
          .insertAdjacentHTML("beforeend", toastHTML);

        // Inicializar y mostrar el toast
        const toastElement = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastElement, {
          autohide: true,
          delay: duracion,
        });

        // Aplicar animación de entrada personalizada
        setTimeout(() => {
          toastElement.style.opacity = "1";
          toastElement.style.transform = "translateY(0)";
        }, 10);

        bsToast.show();

        // Añadir animación de salida antes de eliminar
        toastElement.addEventListener("hide.bs.toast", function () {
          toastElement.style.opacity = "0";
          toastElement.style.transform = "translateY(-20px)";
        });

        // Eliminar el toast del DOM cuando se oculte
        toastElement.addEventListener("hidden.bs.toast", function () {
          toastElement.remove();
        });
      }

      // Función para validar campos requeridos y mostrar errores visuales
      function validarCampoRequerido(input, mensaje = null) {
        // Reiniciar el estilo del campo
        input.classList.remove("is-invalid");

        // Obtener el valor del campo y verificar si está vacío
        const valor = input.value.trim();
        if (!valor) {
          // Resaltar el campo en rojo
          input.classList.add("is-invalid");

          // Mostrar mensaje de error debajo del campo si no existe
          let feedbackEl = input.nextElementSibling;
          if (
            !feedbackEl ||
            !feedbackEl.classList.contains("invalid-feedback")
          ) {
            feedbackEl = document.createElement("div");
            feedbackEl.className = "invalid-feedback";
            feedbackEl.textContent = mensaje || "Este campo es obligatorio";
            input.parentNode.insertBefore(feedbackEl, input.nextSibling);
          }

          return false;
        }

        return true;
      }

      // Función para limpiar validación visual cuando el usuario interactúa con el campo
      function agregarLimpiezaValidacion(input) {
        input.addEventListener("input", function () {
          input.classList.remove("is-invalid");
        });

        input.addEventListener("focus", function () {
          input.classList.remove("is-invalid");
        });
      }

      // Agregar limpieza de validación a los campos de nombre cuando el DOM esté listo
      document.addEventListener("DOMContentLoaded", function () {
        // Campos de nombre
        const nombreManual = document.getElementById("nombre_etiqueta");
        const nombreExistente = document.getElementById(
          "nombre_etiqueta_actual"
        );

        if (nombreManual) {
          agregarLimpiezaValidacion(nombreManual);
        }

        if (nombreExistente) {
          agregarLimpiezaValidacion(nombreExistente);
        }

        // Configurar el campo de nombre duplicado para limpiar validación
        const nombreDuplicado = document.getElementById(
          "etiqueta_duplicada_nombre"
        );
        if (nombreDuplicado) {
          agregarLimpiezaValidacion(nombreDuplicado);
        }

        // Configurar el modal de duplicar etiqueta
        const modalDuplicar = document.getElementById("modalDuplicarEtiqueta");
        if (modalDuplicar) {
          // Limpiar y reiniciar el modal cada vez que se oculta
          modalDuplicar.addEventListener("hidden.bs.modal", function () {
            // Limpiar cualquier estado de error
            const nombreDuplicado = document.getElementById(
              "etiqueta_duplicada_nombre"
            );
            if (nombreDuplicado) {
              nombreDuplicado.classList.remove("is-invalid");
            }

            // Habilitar el botón de confirmar (en caso de que estuviera deshabilitado)
            const btnConfirmar = document.getElementById(
              "btnConfirmarDuplicar"
            );
            if (btnConfirmar) {
              btnConfirmar.disabled = false;
            }
          });

          // Configurar el foco al mostrar el modal
          modalDuplicar.addEventListener("shown.bs.modal", function () {
            // Cuando se muestra el modal, dar foco al campo de nombre
            const nombreDuplicado = document.getElementById(
              "etiqueta_duplicada_nombre"
            );
            if (nombreDuplicado) {
              nombreDuplicado.focus();
              nombreDuplicado.select();
            }
          });
        }
      });
    </script>
  </body>
</html>
